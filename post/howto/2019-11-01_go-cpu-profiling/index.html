<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go CPU profiling - MetalBlueberry - A passionate programmer</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="MetalBlueberry" /><meta name="description" content="Practical example of CPU profiling to optimize a Go program" /><meta name="keywords" content="mandelbrot, go, golang, profiling, cpu, pprof" />






<meta name="generator" content="Hugo 0.58.3 with theme even" />


<link rel="canonical" href="https://metalblueberry.github.io/post/howto/2019-11-01_go-cpu-profiling/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/style.css">


<meta property="og:title" content="Go CPU profiling" />
<meta property="og:description" content="Practical example of CPU profiling to optimize a Go program" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://metalblueberry.github.io/post/howto/2019-11-01_go-cpu-profiling/" />

<meta property="og:image" content="https://media.licdn.com/dms/image/C5603AQEAio-1dZdrEg/profile-displayphoto-shrink_200_200/0?e=1578528000&v=beta&t=ZGwNytWjwnQIrOL0Xqr5NrrD4aWiwoAaPQrI9WqXXVU" />
<meta property="article:published_time" content="2019-11-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-11-01T00:00:00+00:00" />
<meta itemprop="name" content="Go CPU profiling">
<meta itemprop="description" content="Practical example of CPU profiling to optimize a Go program">


<meta itemprop="datePublished" content="2019-11-01T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-01T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2338">



<meta itemprop="keywords" content="go,mandelbrot," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://media.licdn.com/dms/image/C5603AQEAio-1dZdrEg/profile-displayphoto-shrink_200_200/0?e=1578528000&v=beta&t=ZGwNytWjwnQIrOL0Xqr5NrrD4aWiwoAaPQrI9WqXXVU"/>

<meta name="twitter:title" content="Go CPU profiling"/>
<meta name="twitter:description" content="Practical example of CPU profiling to optimize a Go program"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">MetalBlueberry</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">MetalBlueberry</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go CPU profiling</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-11-01 </span>
        <div class="post-category">
    <a class="howto"  href="/categories/howto/"> howto </a>
    </div>
          <span class="more-meta"> 2338 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#write-some-benchmarks">Write some benchmarks</a>
<ul>
<li><a href="#the-good-feeling">The good feeling</a></li>
<li><a href="#full-benchmark">Full benchmark</a></li>
</ul></li>
<li><a href="#cpu-profiling">CPU profiling</a></li>
<li><a href="#optimizations">Optimizations</a>
<ul>
<li><a href="#progress-reporting">Progress reporting</a></li>
<li><a href="#slice-traversal">Slice traversal</a></li>
<li><a href="#math-pow">math.Pow</a></li>
<li><a href="#pointer-dereference">Pointer dereference</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Let&rsquo;s take a look to Go CPU profiling tools to optimize the mandelbrot set calculation from previous post.</p>

<div class="admonition warning"><p class="admonition-title">warning</p>
  
<p>You should read <a href="/post/howto/2019-10-31_mandelbrot-set-calculation/">the previous post</a> to understand the context of this post.</p>


</div>

<p>After comparing the performance of the <a href="/post/howto/2019-10-31_mandelbrot-set-calculation/">Mandelbrot Set Calculation</a> with the interactive viewer online, I&rsquo;ve realized that the performance is really poor. For that reason, I&rsquo;m creating this post to show how to use CPU profiling tools to detect the bottleneck of the code and fix it.</p>

<h2 id="write-some-benchmarks">Write some benchmarks</h2>

<h3 id="the-good-feeling">The good feeling</h3>

<p>At first sight I see that the method <code>Diverges</code> can be easily optimized by avoiding the square root. So let&rsquo;s write some benchmarks to test that I&rsquo;m right.</p>

<p>The value external variable is to avoid optimizations during compile time that may reduce the benchmark time. <a href="https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go">Dave Cheney</a> explain all the details in his blog.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">value</span> <span class="kt">bool</span>

<span class="kd">func</span> <span class="nf">BenchmarkDiverges</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">point</span> <span class="o">:=</span> <span class="nf">NewPoint</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="nx">value</span> <span class="p">=</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Diverges</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Diverges</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">cmplx</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nb">complex</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>I&rsquo;ve left the <code>Diverges</code> function here just as a reminder. let&rsquo;s run the benchmarks to see the output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">╰─&gt;$ go <span class="nb">test</span>  -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkDiverges
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkDiverges-6     <span class="m">168255253</span>                <span class="m">6</span>.43 ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">1</span>.464s</code></pre></td></tr></table>
</div>
</div>
<p>So we have 6.43 ns/op which is quite good. Let&rsquo;s modify the Diverges function and run it again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Diverges</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">real</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">real</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">+</span><span class="nb">imag</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">imag</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">4</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">╰─&gt;$ go <span class="nb">test</span>  -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkDiverges
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkDiverges-6     <span class="m">227208410</span>                <span class="m">5</span>.10 ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">1</span>.625s</code></pre></td></tr></table>
</div>
</div>
<p>There is a drop from 6.43 ns/op to 5.10 ns/op and <strong>this is a 20% faster!</strong> we are on the good track.</p>

<p>The bad news are that this is not the best way of optimizing the code. First we need to analyze it to see if saving 1 ns/op in this function is relevant or not to the whole computational work.</p>

<h3 id="full-benchmark">Full benchmark</h3>

<p>Let&rsquo;s write a benchmark function that simulates the whole process. The idea is to be as similar as possible to the main.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">mandelbrot_test</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;testing&#34;</span>

  <span class="s">&#34;github.com/metalblueberry/mandelbrot/mandelbrot&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">BenchmarkArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">{</span>
    <span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="mi">200</span><span class="p">,</span>
    <span class="nx">MaxIterations</span><span class="p">:</span>        <span class="mi">200</span><span class="p">,</span>
    <span class="nx">TopLeft</span><span class="p">:</span>              <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">BottomRight</span><span class="p">:</span>          <span class="nb">complex</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="nx">set</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
  <span class="c1">// Start benchmarking here
</span><span class="c1"></span>  <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">set</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">()</span>
    <span class="c1">// loop until p is closed
</span><span class="c1"></span>    <span class="k">for</span> <span class="k">range</span> <span class="nx">p</span> <span class="p">{</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>First let&rsquo;s compare the output with old Diverge function vs the output with the new one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## Initial</span>
╰─&gt;$ go <span class="nb">test</span>  -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkArea
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6             <span class="m">2016</span>            <span class="m">564276</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">2</span>.176s

<span class="c1">## Optimized</span>
╰─&gt;$ go <span class="nb">test</span>  -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkArea
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6             <span class="m">3144</span>            <span class="m">351339</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">1</span>.950s</code></pre></td></tr></table>
</div>
</div>
<p>The code is 40% faster for this given section of the mandelbrot set, and we&rsquo;ve just removed a square root calculation.</p>

<h2 id="cpu-profiling">CPU profiling</h2>

<p>I&rsquo;m going to run the full benchmark again but this time with the flag <code>-cpuprofile</code> and this will generate a profiling file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkArea  -cpuprofile profile.out</code></pre></td></tr></table>
</div>
</div>
<p>To visualize the profile.out file, we need the go tool pprof. It is a really powerful tool, but for now, let&rsquo;s keep it simple and just run the web interface with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">go tool pprof -http localhost:8080 profile.out</code></pre></td></tr></table>
</div>
</div>
<p>The web page will open in the graph view. But personally I prefer to visualize this as a flame graph. You can do this by clicking in <a href="http://localhost:8080/ui/flamegraph">view&gt;flame graph</a>.</p>

<p><img src="flamegraph-master.png" alt="flamegraph-master" /></p>

<p>And here is the problem. <strong>cmplx.Abs function is taking 31.74% of the time</strong>. Let&rsquo;s run the benchmark again but with the optimization.</p>

<p><img src="flamegraph-improved.png" alt="flamegraph-improved" /></p>

<p>Wonderful. The Diverges function now only takes 8.45% of the time. what is the next top offender to the computation time? To answer this question we can keep looking at the flame graph or go directly to the <code>top</code> view where we can see the time spent in each function.</p>

<table>
<thead>
<tr>
<th>flat</th>
<th>flat%</th>
<th>sum%</th>
<th>cum</th>
<th>cum%</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>680ms</td>
<td>31.92%</td>
<td>31.92%</td>
<td>2060ms</td>
<td>96.71%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Area).Calculate.func1</td>
</tr>

<tr>
<td>330ms</td>
<td>15.49%</td>
<td>47.42%</td>
<td>350ms</td>
<td>16.43%</td>
<td>runtime.chansend</td>
</tr>

<tr>
<td>260ms</td>
<td>12.21%</td>
<td>59.62%</td>
<td>820ms</td>
<td>38.50%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Point).Calculate</td>
</tr>

<tr>
<td>210ms</td>
<td>9.86%</td>
<td>69.48%</td>
<td>560ms</td>
<td>26.29%</td>
<td>runtime.selectnbsend</td>
</tr>

<tr>
<td>180ms</td>
<td>8.45%</td>
<td>77.93%</td>
<td>180ms</td>
<td>8.45%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Point).Diverges</td>
</tr>

<tr>
<td>90ms</td>
<td>4.23%</td>
<td>82.16%</td>
<td>90ms</td>
<td>4.23%</td>
<td>math.Sincos</td>
</tr>

<tr>
<td>70ms</td>
<td>3.29%</td>
<td>85.45%</td>
<td>70ms</td>
<td>3.29%</td>
<td>math.xatan</td>
</tr>

<tr>
<td>40ms</td>
<td>1.88%</td>
<td>87.32%</td>
<td>40ms</td>
<td>1.88%</td>
<td>math.Hypot</td>
</tr>

<tr>
<td>40ms</td>
<td>1.88%</td>
<td>89.20%</td>
<td>40ms</td>
<td>1.88%</td>
<td>math.IsInf</td>
</tr>

<tr>
<td>40ms</td>
<td>1.88%</td>
<td>91.08%</td>
<td>380ms</td>
<td>17.84%</td>
<td>math/cmplx.Pow</td>
</tr>
</tbody>
</table>

<p>The first surprise here is that runtime.chansend and runtime.selectnbsend are taking 42% of the time and is something that just reports the progress! Let&rsquo;s remove it.</p>

<h2 id="optimizations">Optimizations</h2>

<h3 id="progress-reporting">Progress reporting</h3>

<p>It is important to notice that will make Calculate function synchronous.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Previous
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">(</span><span class="nx">progress</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">progress</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">progress</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pixel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
      <span class="nx">pixel</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pixel</span>

      <span class="k">select</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">progress</span> <span class="o">&lt;-</span> <span class="nx">i</span><span class="p">:</span>
      <span class="k">default</span><span class="p">:</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}()</span>
  <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// New
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pixel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
    <span class="nx">pixel</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pixel</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>We need to remove the channel from the benchmark too</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Previous
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BenchmarkArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">{</span>
    <span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="mi">200</span><span class="p">,</span>
    <span class="nx">MaxIterations</span><span class="p">:</span>        <span class="mi">200</span><span class="p">,</span>
    <span class="nx">TopLeft</span><span class="p">:</span>              <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">BottomRight</span><span class="p">:</span>          <span class="nb">complex</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="nx">set</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
  <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">progress</span> <span class="o">:=</span> <span class="nx">set</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">()</span>
    <span class="k">for</span> <span class="k">range</span> <span class="nx">progress</span> <span class="p">{</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
  

<span class="c1">// New
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BenchmarkArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">{</span>
    <span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="mi">200</span><span class="p">,</span>
    <span class="nx">MaxIterations</span><span class="p">:</span>        <span class="mi">200</span><span class="p">,</span>
    <span class="nx">TopLeft</span><span class="p">:</span>              <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">BottomRight</span><span class="p">:</span>          <span class="nb">complex</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="nx">set</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
  <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">set</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>And the benchmark now is&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkArea  -cpuprofile profile.out
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6             <span class="m">5301</span>            <span class="m">206832</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">2</span>.007s</code></pre></td></tr></table>
</div>
</div>
<p>If you scroll up to check the previous result, we&rsquo;ve improved from 351339 ns/op to 206832 ns/op. Let&rsquo;s get the flame graph and the top to see how to continue.</p>

<table>
<thead>
<tr>
<th>flat</th>
<th>flat%</th>
<th>sum%</th>
<th>cum</th>
<th>cum%</th>
<th></th>
</tr>
</thead>

<tbody>
<tr>
<td>0.93s</td>
<td>49.21%</td>
<td>49.21%</td>
<td>1.89s</td>
<td>100%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Area).Calculate</td>
</tr>

<tr>
<td>0.45s</td>
<td>23.81%</td>
<td>73.02%</td>
<td>0.96s</td>
<td>50.79%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Point).Calculate</td>
</tr>

<tr>
<td>0.17s</td>
<td>8.99%</td>
<td>82.01%</td>
<td>0.17s</td>
<td>8.99%</td>
<td>github.com/metalblueberry/mandelbrot/mandelbrot.(*Point).Diverges</td>
</tr>

<tr>
<td>0.11s</td>
<td>5.82%</td>
<td>87.83%</td>
<td>0.12s</td>
<td>6.35%</td>
<td>math.Sincos</td>
</tr>

<tr>
<td>0.06s</td>
<td>3.17%</td>
<td>91.01%</td>
<td>0.06s</td>
<td>3.17%</td>
<td>math.Hypot</td>
</tr>

<tr>
<td>0.05s</td>
<td>2.65%</td>
<td>93.65%</td>
<td>0.10s</td>
<td>5.29%</td>
<td>math.pow</td>
</tr>

<tr>
<td>0.02s</td>
<td>1.06%</td>
<td>94.71%</td>
<td>0.02s</td>
<td>1.06%</td>
<td>math.Abs</td>
</tr>

<tr>
<td>0.02s</td>
<td>1.06%</td>
<td>95.77%</td>
<td>0.02s</td>
<td>1.06%</td>
<td>math.IsInf</td>
</tr>

<tr>
<td>0.02s</td>
<td>1.06%</td>
<td>96.83%</td>
<td>0.05s</td>
<td>2.65%</td>
<td>math.atan2</td>
</tr>

<tr>
<td>0.01s</td>
<td>0.53%</td>
<td>97.35%</td>
<td>0.01s</td>
<td>0.53%</td>
<td>math.frexp</td>
</tr>
</tbody>
</table>

<p><img src="flamegraph-progress.png" alt="flamegraph-progress" /></p>

<p>96% of the time is spent inside the Area.Calculate function and this means that we are not wasting time doing other stuff. Appart from that, I would expect to spend most of the time inside Point.Calculate, as it is where the iterations are performed. Let&rsquo;s go to the <a href="http://localhost:8080/ui/source">source tab</a> to see the time spent per line.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="nx">Total</span><span class="p">:</span>       <span class="mi">930</span><span class="nx">ms</span>      <span class="mf">1.89</span><span class="nf">s</span> <span class="p">(</span><span class="nx">flat</span><span class="p">,</span> <span class="nx">cum</span><span class="p">)</span>   <span class="mi">100</span><span class="o">%</span>
     <span class="mi">33</span>            <span class="p">.</span>          <span class="p">.</span>           <span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
     <span class="mi">34</span>        <span class="mi">510</span><span class="nx">ms</span>      <span class="mi">510</span><span class="nx">ms</span>             <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pixel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
     <span class="mi">35</span>        <span class="mi">140</span><span class="nx">ms</span>      <span class="mf">1.10</span><span class="nx">s</span>               <span class="nx">pixel</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
     <span class="mi">36</span>        <span class="mi">280</span><span class="nx">ms</span>      <span class="mi">280</span><span class="nx">ms</span>               <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pixel</span>
     <span class="mi">37</span>            <span class="p">.</span>          <span class="p">.</span>             <span class="p">}</span>
     <span class="mi">38</span>            <span class="p">.</span>          <span class="p">.</span>           <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>So we spend <sup>1</sup>&frasl;<sub>3</sub> of the time iterating over the Points array and assigning back the value. I feel a little bit lost at this point so let&rsquo;s just modify the code to see if it can be improved. The first thing I want to try is to replace the range operation for a simple for loop.</p>

<h3 id="slice-traversal">Slice traversal</h3>

<p>This is the new version of the Calculate function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Previous
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">pixel</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
    <span class="nx">pixel</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pixel</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// New
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>BenchmarkArea  -cpuprofile profile.out
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6            <span class="m">10767</span>            <span class="m">105798</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">1</span>.906s</code></pre></td></tr></table>
</div>
</div>
<p><img src="flamegraph-slice-traversal.png" alt="flamegraph-slice-traversal" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="nx">Total</span><span class="p">:</span>       <span class="mi">390</span><span class="nx">ms</span>      <span class="mf">1.71</span><span class="nf">s</span> <span class="p">(</span><span class="nx">flat</span><span class="p">,</span> <span class="nx">cum</span><span class="p">)</span>   <span class="mi">100</span><span class="o">%</span>
    <span class="mi">33</span>            <span class="p">.</span>          <span class="p">.</span>           <span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Area</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
     <span class="mi">34</span>        <span class="mi">210</span><span class="nx">ms</span>      <span class="mi">210</span><span class="nx">ms</span>             <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
     <span class="mi">35</span>        <span class="mi">180</span><span class="nx">ms</span>      <span class="mf">1.50</span><span class="nx">s</span>               <span class="nx">a</span><span class="p">.</span><span class="nx">Points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">)</span>
     <span class="mi">36</span>            <span class="p">.</span>          <span class="p">.</span>             <span class="p">}</span>
     <span class="mi">37</span>            <span class="p">.</span>          <span class="p">.</span>           <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>This change gives us 105798 ns/op which is near two times faster than the previous version! This is great. If you check the initial benchmark, it was 564276 ns/op so this means we are already x5 times faster.</p>

<p>Before continuing the optimization, I&rsquo;ve decided to compare the performance vs the <a href="https://sciencedemos.org.uk/mandelbrot.php">online viewer</a>. Just to have some reference of how fast can this task be performed. The sad news are that for the following section, our implementation takes 100s and the online viewer takes 3.7s.</p>

<p>The BenchmarkComplexArea function is the one that takes 100s.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">BenchmarkArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">{</span>
    <span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="mi">200</span><span class="p">,</span>
    <span class="nx">MaxIterations</span><span class="p">:</span>        <span class="mi">200</span><span class="p">,</span>
    <span class="nx">TopLeft</span><span class="p">:</span>              <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">BottomRight</span><span class="p">:</span>          <span class="nb">complex</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="nf">benchmarkGivenArea</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">set</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">{</span>
    <span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="mi">1060</span><span class="p">,</span>
    <span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="mi">730</span><span class="p">,</span>
    <span class="nx">MaxIterations</span><span class="p">:</span>        <span class="mi">3534</span><span class="p">,</span>
    <span class="nx">TopLeft</span><span class="p">:</span>              <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mf">1.401854499759</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.000743603637</span><span class="p">),</span>
    <span class="nx">BottomRight</span><span class="p">:</span>          <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mf">1.399689899172</span><span class="p">,</span> <span class="mf">0.000743603637</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="nf">benchmarkGivenArea</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">set</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">benchmarkGivenArea</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">set</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">set</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
  <span class="nx">b</span><span class="p">.</span><span class="nf">ResetTimer</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">set</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>When running this benchmark, I&rsquo;ve got an interesting profile.out that shows that 93.13% of the time is spent in math/cmplx.Pow function.</p>

<p><img src="flamegraph-benchmarkComplexArea.png" alt="flamegraph-benchmarkComplexArea" /></p>

<p>This is really sad because this function is really useful and I don&rsquo;t see a clear way of optimizing it. I guess that as this function can handle any power number. An optimization can be just multiplying the number by itself. Let&rsquo;s try.</p>

<h3 id="math-pow">math.Pow</h3>

<p>Another easy change. These are the old and the new version of <code>point.Calculate</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Previous
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">MaxIterations</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nf">Diverges</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span> <span class="p">&lt;</span> <span class="nx">MaxIterations</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span><span class="o">++</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">z</span> <span class="p">=</span> <span class="nx">cmplx</span><span class="p">.</span><span class="nf">Pow</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Point</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// New
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">MaxIterations</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nf">Diverges</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span> <span class="p">&lt;</span> <span class="nx">MaxIterations</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span><span class="o">++</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">z</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="o">*</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Point</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Let&rsquo;s run benchmarks&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## Previous</span>
╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>Area  -cpuprofile profile.out                                                        <span class="m">12</span>:31:28
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6                    <span class="m">12500</span>             <span class="m">96135</span> ns/op
BenchmarkComplexArea-6                 <span class="m">1</span>        <span class="m">103429981309</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">106</span>.306s

<span class="c1">## New</span>
╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>Area  -cpuprofile profile.out
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6                    <span class="m">15406</span>             <span class="m">73572</span> ns/op
BenchmarkComplexArea-6                 <span class="m">1</span>        <span class="m">5013357483</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">5</span>.511s</code></pre></td></tr></table>
</div>
</div>
<p>I think we&rsquo;ve found the top offender to the calculation and easily improved it. now the timing is 5013357483 ns/op for the ComplexArea which is 5.013357483 s/op and this is only 1.3 seconds away from the web page!</p>

<div class="admonition tip"><p class="admonition-title">learning</p>
  
<p>Don&rsquo;t use math.Pow unless you really need it.</p>


</div>

<div class="admonition bug"><p class="admonition-title">bug</p>
  
<p>After this change, the tests are failing because the case <code>(0,1)</code> no longer diverges. We&rsquo;ve solved this numerical issue when removing <code>math.Pow</code> and the tests must be updated.</p>


</div>

<h3 id="pointer-dereference">Pointer dereference</h3>

<p>Inside the method point.Calculate there are several references to variables inside Point. This forces the program to dereference the variables each loop and this is a waste of time. To fix it I&rsquo;m going to create a copy of the variables at the beginning of the method. It is also required to inline the <code>Diverges</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Previous
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">MaxIterations</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nf">Diverges</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span> <span class="p">&lt;</span> <span class="nx">MaxIterations</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span><span class="o">++</span>
    <span class="nx">m</span><span class="p">.</span><span class="nx">z</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="o">*</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Point</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Diverges</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">real</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">real</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">+</span><span class="nb">imag</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">imag</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">4</span>
<span class="p">}</span>

<span class="c1">// New
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Point</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">MaxIterations</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">z</span> <span class="kt">complex128</span>
  <span class="nx">point</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Point</span>
  <span class="nx">iterations</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span>

  <span class="k">for</span> <span class="nb">real</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">real</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span><span class="o">+</span><span class="nb">imag</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span><span class="o">*</span><span class="nb">imag</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">iterations</span> <span class="p">&lt;</span> <span class="nx">MaxIterations</span> <span class="p">{</span>
    <span class="nx">iterations</span><span class="o">++</span>
    <span class="nx">z</span> <span class="p">=</span> <span class="nx">z</span><span class="o">*</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">point</span>
  <span class="p">}</span>

  <span class="nx">m</span><span class="p">.</span><span class="nx">iterations</span> <span class="p">=</span> <span class="nx">iterations</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>And running benchmarks again&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## Previous</span>
╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>.
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6                    <span class="m">16176</span>             <span class="m">76731</span> ns/op
BenchmarkComplexArea-6                 <span class="m">1</span>        <span class="m">5011883400</span> ns/op
BenchmarkCalculate-6               <span class="m">94263</span>             <span class="m">12727</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">8</span>.308s

<span class="c1">## New</span>
╰─&gt;$ go <span class="nb">test</span> -run<span class="o">=</span><span class="s1">&#39;^$&#39;</span> -bench<span class="o">=</span>.
goos: linux
goarch: amd64
pkg: github.com/metalblueberry/mandelbrot/mandelbrot
BenchmarkArea-6                    <span class="m">13608</span>             <span class="m">81561</span> ns/op
BenchmarkComplexArea-6                 <span class="m">1</span>        <span class="m">3520533936</span> ns/op
BenchmarkCalculate-6              <span class="m">130862</span>              <span class="m">8912</span> ns/op
PASS
ok      github.com/metalblueberry/mandelbrot/mandelbrot <span class="m">6</span>.284s</code></pre></td></tr></table>
</div>
</div>
<p>It is interesting that the benchmark for the first area is slightly slower even though the other two are faster. I can&rsquo;t give a explanation why this happen. Anyway, the time for the complex are is&hellip; 3.5 seconds!! faster than the webpage.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I&rsquo;m really happy with the result of the optimization. We have improved the code to run 85% faster than the initial version and this is quite impressive. I think the next step is to render the set by chunks to parallelize the computational task and take advantage of the multiple cores.</p>

<p>You can explore the repository to see the whole code and to play with it here.</p>

<p>Thank you for reading and feel free to leave a comment bellow, I will be really happy to hear from you.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go">How to write go benchmark by Dave Cheney</a></li>
<li><a href="https://www.speedscope.app/">Online flamegraph visualizer</a></li>
<li><a href="https://sciencedemos.org.uk/mandelbrot.php">Online mandelbrot visualizer</a></li>
<li><a href="https://github.com/bradfitz/talk-yapc-asia-2015/blob/master/talk.md">Profiling &amp; Optimizing in Go</a></li>
</ul>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go/">go</a>
          <a href="/tags/mandelbrot/">mandelbrot</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/howto/2019-10-31_mandelbrot-set-calculation/">
            <span class="next-text nav-default">Mandelbrot Set Calculation</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="MetalBlueberry/MetalBlueberry.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:metalblueberry@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/MetalBlueberry" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.linkedin.com/in/victorperezdomingo/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/MetalBlueberry" class="iconfont icon-github" title="github"></a>
  <a href="https://metalblueberry.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">MetalBlueberry</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-150427130-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
