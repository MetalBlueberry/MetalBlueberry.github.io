<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Mandelbrot Parallel Computation - MetalBlueberry - A passionate programmer</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="MetalBlueberry" /><meta name="description" content="Use golang concurrent tools to speedup mandelbrot set calculation" /><meta name="keywords" content="mandelbrot, go, golang, concurrent, parallel, multithread" />






<meta name="generator" content="Hugo 0.59.1 with theme even" />


<link rel="canonical" href="https://metalblueberry.github.io/post/howto/2019-11-17_mandelbrot_parallel_computation/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/style.css">


<meta property="og:title" content="Mandelbrot Parallel Computation" />
<meta property="og:description" content="Use golang concurrent tools to speedup mandelbrot set calculation" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://metalblueberry.github.io/post/howto/2019-11-17_mandelbrot_parallel_computation/" />

<meta property="og:image" content="https://metalblueberry.github.io/me.jpeg" />
<meta property="article:published_time" content="2019-11-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-11-24T00:00:00+00:00" />
<meta itemprop="name" content="Mandelbrot Parallel Computation">
<meta itemprop="description" content="Use golang concurrent tools to speedup mandelbrot set calculation">


<meta itemprop="datePublished" content="2019-11-17T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-24T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6060">



<meta itemprop="keywords" content="go,mandelbrot," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://metalblueberry.github.io/me.jpeg"/>

<meta name="twitter:title" content="Mandelbrot Parallel Computation"/>
<meta name="twitter:description" content="Use golang concurrent tools to speedup mandelbrot set calculation"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">MetalBlueberry</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">MetalBlueberry</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  
  <header class="post-header">
    <h1 class="post-title">Mandelbrot Parallel Computation</h1>
    <script src="https://cdn.plot.ly/plotly-1.50.0.min.js"></script>

    <div class="post-meta">
      <span class="post-time"> 2019-11-17 </span>
      <div class="post-category">
    <a class="howto"  href="/categories/howto/"> howto </a>
    </div>
      <span class="more-meta"> 6060 words </span>
      <span class="more-meta"> 29 mins read </span>
      
    </div>
    &lt;nil&gt;
    
  </header>

  <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-mandelbrot-picture-struct">The Mandelbrot Picture Struct</a></li>
<li><a href="#calculation">Calculation</a>
<ul>
<li><a href="#task-synchronization-with-sync-waitgroup">Task Synchronization With sync.WaitGroup</a></li>
<li><a href="#work-queue">Work Queue</a></li>
<li><a href="#work-progress-report">Work Progress Report</a></li>
<li><a href="#calculation-execution-context">Calculation Execution Context</a></li>
</ul></li>
<li><a href="#configuration-and-benchmarks">Configuration And Benchmarks</a></li>
<li><a href="#mandelbrot-cli">Mandelbrot CLI</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
  <div class="post-content">
    <p>This post explains how to parallelize the computational task of the Mandelbrot set and generate a terminal tool to generate images.</p>

<div class="admonition warning"><p class="admonition-title">warning</p>
  
<p>You should read <a href="/post/howto/2019-11-01_go-cpu-profiling/">the previous post</a> to understand the context of this post.</p>


</div>

<p>We left it after improving drastically the performance of our code by running benchmarks and drawing flame graphs with pprof. The problem is we almost hit the limit of the optimization following this line. Now we are going to take advantage of the tools provided by Go to implement a parallel computation that will reduce the total computational time.</p>

<h2 id="introduction">Introduction</h2>

<p>The first thing to do is to identify the parts of the computation that can be calculated independently from the others. Luckily, in the Mandelbrot set, the calculation if each point belongs to the set, is completely independent from other points. This makes really simple to split the work over multiple cores.</p>

<p>Next think to ask ourself is, is it worth to spawn a goroutine for each point? Reading documentation about go internals, this can be done, but it is not a good practice. This is because the task that we are performing is CPU intensive and this will effectively limit the maximum number of goroutines running to the maximum number of available cores in the system. So, theoretically, the maximum number of routines should be the number of cores.</p>

<p>Knowing that this encourages a producer-consumer pattern. The next questions is, what is the optimal way to split the tasks? we know that the calculation for each point is the minium part that can be calculated independently. Should we group some points as a single task? if yes, how many? I think the best way to answer this question is to benchmark the code.</p>

<div class="admonition info"><p class="admonition-title">Info</p>
  
<p>The idea that I&rsquo;ve in mind comes from how Blender renders complex images. here is a gif of a render divided in little squares.</p>

<p><img src="https://devtalk.blender.org/uploads/default/original/1X/79d5a6dd63de7dead05d73e29ed263f66f43af16.gif#center" alt="blenderrender" /></p>


</div>

<h2 id="the-mandelbrot-picture-struct">The Mandelbrot Picture Struct</h2>

<p>To hold the data together and to coordinate the calculation, I&rsquo;ve created a new structure called Picture. Then, we have a <code>mandelbot.Point</code>, as the minimal computational unit. <code>mandelbot.Area</code>, as a group of Points that will be calculated together. And <code>mandelbot.Picture</code> as a group of Areas.</p>

<p><img src="./Picture Description.svg#center" alt="Picture Description" /></p>

<p>The previous picture is a visual representation of what the variables of the Picture structure actually mean. Blue ones are in pixels and represent the final image that will be build. The red ones are in float point precision and represent the mandelbrot area. The axis are just there as an orientation</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Picture</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">TopLeft</span>       <span class="kt">complex128</span>
	<span class="nx">ChunkSize</span>     <span class="kt">float64</span>
	<span class="nx">MaxIterations</span> <span class="kt">int</span>

	<span class="nx">HorizontalImageChunks</span> <span class="kt">int</span>
	<span class="nx">VerticalImageChunks</span>   <span class="kt">int</span>
	<span class="nx">ChunkImageSize</span>        <span class="kt">int</span>

	<span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>The strategy of storing 2D data in a single array is also being used here with exactly the same approach. To initialize the data, I also have the <code>picture.Init</code> function that initializes the picture and all the recursive areas. This function performs the calculation to assign to each area the corresponding section of the complex area that must render. Based on the x,y position and the ChunkSize, it is easy to calculate the TopLeft and BottomRight of each area. The only tricky thing is that to move from TopToBottom, we need to subtract instead of adding. thats why you see the minus sign next to the imaginary parts. Also, after creating the Area with the calculated values, there is a call to <code>area.Init</code> to guarantee that everything is initialised.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">.</span><span class="nx">areas</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">HorizontalImageChunks</span><span class="o">*</span><span class="nx">p</span><span class="p">.</span><span class="nx">VerticalImageChunks</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">ForIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
		<span class="nx">areaTopLeft</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">TopLeft</span> <span class="o">+</span> <span class="nb">complex</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ChunkSize</span><span class="o">*</span><span class="nb">float64</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">ChunkSize</span><span class="o">*</span><span class="nb">float64</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
		<span class="nx">areaBottomRight</span> <span class="o">:=</span> <span class="nx">areaTopLeft</span> <span class="o">+</span> <span class="nb">complex</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">ChunkSize</span><span class="p">,</span> <span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">ChunkSize</span><span class="p">)</span>

		<span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">Area</span><span class="p">{</span>
			<span class="nx">TopLeft</span><span class="p">:</span>              <span class="nx">areaTopLeft</span><span class="p">,</span>
			<span class="nx">BottomRight</span><span class="p">:</span>          <span class="nx">areaBottomRight</span><span class="p">,</span>
			<span class="nx">HorizontalResolution</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">ChunkImageSize</span><span class="p">,</span>
			<span class="nx">VerticalResolution</span><span class="p">:</span>   <span class="nx">p</span><span class="p">.</span><span class="nx">ChunkImageSize</span><span class="p">,</span>
			<span class="nx">MaxIterations</span><span class="p">:</span>        <span class="nx">p</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Init</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="calculation">Calculation</h2>

<p>Let&rsquo;s start with a simple loop to calculate all the areas inside the Picture. It will look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>The firs way is to decide how are we going to split the areas slice for the workers. <strong>My first attempt</strong> was to slice the slice intro subparts with the same number of elements, but this approach has a few drawbacks. First, when the operation len(p.areas)/workers generates a remained, it becomes tricky which worker should do it. Also, not all the areas require the same number of iterations, so this approach generates unbalanced workers. This is how the code looks like</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">works</span> <span class="o">:=</span> <span class="nf">splitWorks</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">,</span> <span class="nx">workerCount</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">works</span><span class="p">);</span> <span class="nx">w</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">works</span><span class="p">[</span><span class="nx">w</span><span class="p">])</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">splitWorks</span><span class="p">(</span><span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">works</span> <span class="p">[][]</span><span class="nx">Area</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Split []Area in [][]Area, omitted for simplicity
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">){</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="task-synchronization-with-sync-waitgroup">Task Synchronization With sync.WaitGroup</h3>

<p>The firs issue with this code is that the Calculate function no longer blocks the code and it exist before the computation finishes. To address this issue, we have <code>sync.WaitGroup</code>. A wait group is a simple structure that keeps track of the works that are being executed in parallel and allows easy synchronization to wait for all of them to finish. After creating the <code>wg := &amp;sync.WaitGroup{}</code>, you must call to <code>wg.Add</code> with the number of expected workers and then, call <code>wg.Done</code> when each of the workers finish. This allows to wait for all of them to exit with a simple call to <code>wg.Wait</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Setup wg and WorkerCount
</span><span class="c1"></span>	<span class="nx">wg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">workerCount</span><span class="p">)</span>

	<span class="nx">works</span> <span class="o">:=</span> <span class="nf">splitWorks</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">w</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">works</span><span class="p">);</span> <span class="nx">w</span><span class="o">++</span> <span class="p">{</span>
		<span class="c1">// send the wg to the worker
</span><span class="c1"></span>		<span class="k">go</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">works</span><span class="p">[</span><span class="nx">w</span><span class="p">])</span>
	<span class="p">}</span>
	<span class="c1">// Wait for all the workers to finish
</span><span class="c1"></span>	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">splitWorks</span><span class="p">(</span><span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">works</span> <span class="p">[][]</span><span class="nx">Area</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// Split []Area in [][]Area, omitted for simplicity
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">){</span>
	<span class="c1">// when the work is done, notify the wg
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="work-queue">Work Queue</h3>

<p>I&rsquo;m not really happy with the approach of splitting the work for the various reasons I&rsquo;ve described before. In the <strong>second attempt</strong>, I decided to generate queue with all the areas pending to be processed and the workers just pick new jobs from there until all are done. Let&rsquo;s create the function to initialize the queue based on a channel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">workCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">next</span> <span class="o">&lt;-</span> <span class="nx">i</span>
		<span class="p">}</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="k">return</span> <span class="nx">next</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Given a workCount, this function returns a channel that returns sequentially the numbers from 0 to workCount - 1. This fits perfectly to the indexes of a slice and this is how we are going to use it. First, we have to modify our workers to accept the work from a channel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">next</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">){</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">next</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>The range function used over a channel, returns elements until the channel is closed. This is really handy to implement the work queue. The code looks even easier than before. Let&rsquo;s see all together.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">wg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">workerCount</span><span class="p">)</span>

	<span class="nx">next</span> <span class="o">:=</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">worker</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">worker</span> <span class="p">&lt;</span> <span class="nx">workerCount</span><span class="p">;</span> <span class="nx">worker</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">workCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">next</span> <span class="o">&lt;-</span> <span class="nx">i</span>
		<span class="p">}</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="k">return</span> <span class="nx">next</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">next</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">next</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="work-progress-report">Work Progress Report</h3>

<p>Remember when we tried to implement progress reporting using channels and this drastically reduced the performance? well, It was clearly over engineered to report every iteration of the calculation. But with this new structure, it would be easy and cheap to report each time one of the workers finish the calculation of an area. This will enable potential consumers to start drawing it or just notify us of the global process. I will be using the same approach as the workQueue. The calculate function will return a channel that reports the updates. To keep things clear, I will also create the method <code>picture.CalculateAsync</code> to create the channel for the consumer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workerCount</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">doneIndex</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">wg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">workerCount</span><span class="p">)</span>

	<span class="nx">next</span> <span class="o">:=</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">worker</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">worker</span> <span class="p">&lt;</span> <span class="nx">workerCount</span><span class="p">;</span> <span class="nx">worker</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">doneIndex</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>

	<span class="nb">close</span><span class="p">(</span><span class="nx">doneIndex</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">doneIndex</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workerCount</span><span class="p">,</span> <span class="nx">doneIndex</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">doneIndex</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">next</span> <span class="o">&lt;-</span> <span class="nx">i</span>
		<span class="p">}</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="k">return</span> <span class="nx">next</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">next</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">doneIndex</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">next</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
		<span class="nx">doneIndex</span> <span class="o">&lt;-</span> <span class="nx">i</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="calculation-execution-context">Calculation Execution Context</h3>

<p>The doneIndex channel carries the index of the Area that has been finished. The consumer only needs to wait for a number to arrive, and then, get the corresponding Area from the Picture. We will see this code later. Now we have to add one last thing to this code. The calculation can take a long time or we may require to stop it before finishing. To implement this, we have the <code>context.Context</code>. From the docs <em>A Context carries a deadline, a cancellation signal, and other values across API boundaries.</em> let&rsquo;s see how the code looks like.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workerCount</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">doneIndex</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">wg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
	<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">workerCount</span><span class="p">)</span>

	<span class="nx">next</span> <span class="o">:=</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">))</span>

	<span class="k">for</span> <span class="nx">worker</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">worker</span> <span class="p">&lt;</span> <span class="nx">workerCount</span><span class="p">;</span> <span class="nx">worker</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">go</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">areas</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">doneIndex</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>

	<span class="nb">close</span><span class="p">(</span><span class="nx">doneIndex</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Picture</span><span class="p">)</span> <span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workerCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">doneIndex</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Calculate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workerCount</span><span class="p">,</span> <span class="nx">doneIndex</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">doneIndex</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">workQueue</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">workCount</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
				<span class="k">return</span>
			<span class="k">case</span> <span class="nx">next</span> <span class="o">&lt;-</span> <span class="nx">i</span><span class="p">:</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nb">close</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
	<span class="p">}()</span>
	<span class="k">return</span> <span class="nx">next</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doWork</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">areas</span> <span class="p">[]</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">next</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">doneIndex</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">next</span> <span class="p">{</span>
		<span class="nx">areas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Calculate</span><span class="p">()</span>
		<span class="nx">doneIndex</span> <span class="o">&lt;-</span> <span class="nx">i</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>So the tricky thing here is that the workQueue now has two options. A. Publish a new work to be done to the <code>next</code> channel. B. receive a <code>ctx.Done</code> signal and close the <code>next</code> channel. When B happens. this will stop the workers after they finish the current task. This is not the ideal situation because an external user will expect the function to return almost immediately after context cancellation. The problem is that achieving this, can be a little more trick because we cannot just cancel a running goroutine. Also, we cannot close the <code>doneIndex</code> channel until all the workers have finished their work because, if the channel is closed, the workers will panic when publishing the index after calculation. Nevertheless, It is possible to handle such case with a similar select statement to the one used in the <code>workerQueue</code> and adding another go routine in the calculate function to listen for the <code>wg.Wait()</code>. But I think this is too complex for this case. so I will keep it like this for now.</p>

<h2 id="configuration-and-benchmarks">Configuration And Benchmarks</h2>

<p>We have everything ready run our code in parallel, but there are a lot of different setting configurations that can affect the performance of the calculation. The best way to find the appropriate configuration is to run benchmarks and see where the performance is better.</p>

<p>This is the list of parameters that we can modify to change how the work is going to be processed by the workers.</p>

<ul>
<li>Image dimensions

<ul>
<li>HorizontalImageChunks</li>
<li>VerticalImageChunks</li>
<li>ChunkImageSize</li>
</ul></li>
<li>Workers</li>
</ul>

<p>To keep a constant image size, the following operation must be constant.</p>

<p>$$HorizontalImageChunks*VerticalImageChunks*ChunkImageSize^2$$</p>

<p>Now we need to choose an image size and try all the combinations of these values. I&rsquo;ve started with an image of 1024x1024 in the Mandelbrot area <code>topLeft:(-1.401854499759, -0.000743603637), bottomRight: (1,180199459759,0,222398643637)</code>. The most fragmented case is when I divide the image in 1024x1024 areas of 1 pixel and the less fragmented is just 1 area of 1024x1024 pixels. In the following graph you can see the benchmark results for all the power of 2 combinations from the most fragmented to the less fragmented. In the X axis, the numbers of the previous multiplication. in the Y axis, the s/op returned by the benchmark.  The Y axis is in logarithmic scale to improve the visualization. You can hover the mouse over any point to see the exact value. The horizontal lines represent the optimal speed based on the 1 worker benchmark. is expected to get x2 x3 x4 etc&hellip; speed for each extra worker. You also need to know that my computer has 6 cores.</p>

<div class="figure">
<div class="figure-plot" id="figure1">
	Code could not finish, this are some reasons why this happen.
	- Plot name not defined. The first parameter of the shortcode is the name.
	- There is a syntax error. check browser console.
</div>
<script>
  function draw(){
	test = document.getElementById("figure1");
	if (test == null){
		console.log("The plot name is not defined")
		return
	}

	fig = null
	
fig = {"data":[{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[5.319377513,3.730183194,3.492960513,3.416568462,3.406160365,3.404795796,3.401629099,3.403963371,3.406568944,3.403851128,3.401489335],"name":"1 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[5.105426336,2.403512541,1.769243872,1.720678808,1.705878765,1.702246865,1.705907853,1.731687894,1.819791773,1.954560985,3.404077505],"name":"2 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[4.665434148,1.840141806,1.23159353,1.156602142,1.139298289,1.135465838,1.145931396,1.190932724,1.324346159,1.955651422,3.401555276],"name":"3 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[3.277424857,1.508889857,1.000251994,0.877004851,0.855757891,0.851836168,0.859728354,0.902649372,1.012687753,1.955834209,3.404003372],"name":"4 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[2.687810723,1.299930746,0.848919389,0.71687461,0.697146793,0.686797944,0.695021475,0.733307298,0.782258103,1.958691928,3.406197102],"name":"5 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[2.419063112,1.172598442,0.770078822,0.636418239,0.59517132,0.58758251,0.598871324,0.655497364,0.722161112,1.955789037,3.40305645],"name":"6 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[1.991583443,1.033091053,0.712726608,0.605582734,0.578420338,0.577574125,0.580463384,0.652894185,0.691949137,1.970116638,3.452580344],"name":"7 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[1.942149854,0.947873093,0.683032395,0.605635427,0.575207906,0.573205018,0.580969231,0.653116053,0.72285752,1.954330764,3.407772597],"name":"8 workers"}],"layout":{"title":"Benchmark results","yaxis":{"title":"s/op","type":"log","autorange":true},"shapes":[{"type":"line","xref":"paper","yref":"y","y0":3.40394218,"x0":0,"y1":3.40394218,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":1.70197109,"x0":0,"y1":1.70197109,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":1.1346473933333334,"x0":0,"y1":1.1346473933333334,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.850985545,"x0":0,"y1":0.850985545,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.680788436,"x0":0,"y1":0.680788436,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.5673236966666667,"x0":0,"y1":0.5673236966666667,"x1":1,"line":{"width":1}}],"margin":{"l":25,"r":5,"b":75,"t":50,"pad":4}},"config":{"responsive":true}}


	if (!fig) {
		test.innerText = "ERROR: fig variable is not defined"
		return
	}
	test.innerText = null
	Plotly.plot(test ,fig);
  }
  draw()
</script>
</div>

<p>There a few interesting things in this graph.</p>

<ol>
<li>If the image only contains 1 area, the benchmark is independent of the number of cores. You can see this at the right point of the graph.</li>
<li>If the image is divided in too many areas. The performance is deteriorated for all the setups. This is the left part of the graph.</li>
<li>All the lines have a parabolic shape with a minimum in 32x32x32. This is the best setup for my computer.</li>
<li>Selecting the minimum point, the performance is doubled almost perfectly for each worker added until reaching the system limit of 6 cores.</li>
<li>The performance still increases after 6 workers, but it never reaches the x6 speed.</li>
<li>The performance in 512x512x2 is the same after the 2nd worker. I think this is because not all the sections in the set are equally expensive to calculate. The hardest one is closer to the right top because is almost all black.</li>
</ol>

<p>Here is the code that runs the benchmarks.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">HorizontalImageChunks</span><span class="p">,</span> <span class="nx">VerticalImageChunks</span><span class="p">,</span> <span class="nx">ChunkImageSize</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
		<span class="nx">pic</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Picture</span><span class="p">{</span>
			<span class="nx">TopLeft</span><span class="p">:</span>               <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mf">1.401854499759</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.000743603637</span><span class="p">),</span>
			<span class="nx">MaxIterations</span><span class="p">:</span>         <span class="mi">3534</span><span class="p">,</span>
			<span class="nx">ChunkSize</span><span class="p">:</span>             <span class="mf">0.00021646</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">ChunkImageSize</span><span class="p">),</span>
			<span class="nx">HorizontalImageChunks</span><span class="p">:</span> <span class="nx">HorizontalImageChunks</span><span class="p">,</span>
			<span class="nx">VerticalImageChunks</span><span class="p">:</span>   <span class="nx">VerticalImageChunks</span><span class="p">,</span>
			<span class="nx">ChunkImageSize</span><span class="p">:</span>        <span class="nx">ChunkImageSize</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
		<span class="nx">pic</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>

		<span class="nx">done</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span>
		<span class="k">for</span> <span class="k">range</span> <span class="nx">done</span> <span class="p">{</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="o">*</span><span class="nx">saveImage</span> <span class="p">{</span>
			<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
			<span class="nf">saveImageFrom</span><span class="p">(</span><span class="nx">pic</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;bench_%d_%d_%d_w_%d.jpeg&#34;</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">HorizontalImageChunks</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">VerticalImageChunks</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">ChunkImageSize</span><span class="p">,</span> <span class="nx">workers</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;"
        onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
            
            
            &gt; Click here to see all code
            
        </span>
    </div>
    <div class="expand-content" style="display: none;">
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">saveImage</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;saveImage&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;save the result of running the benchmarks&#34;</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">HorizontalImageChunks</span><span class="p">,</span> <span class="nx">VerticalImageChunks</span><span class="p">,</span> <span class="nx">ChunkImageSize</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
		<span class="nx">pic</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Picture</span><span class="p">{</span>
			<span class="nx">TopLeft</span><span class="p">:</span>               <span class="nb">complex</span><span class="p">(</span><span class="o">-</span><span class="mf">1.401854499759</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.000743603637</span><span class="p">),</span>
			<span class="nx">MaxIterations</span><span class="p">:</span>         <span class="mi">3534</span><span class="p">,</span>
			<span class="nx">ChunkSize</span><span class="p">:</span>             <span class="mf">0.00021646</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">ChunkImageSize</span><span class="p">),</span>
			<span class="nx">HorizontalImageChunks</span><span class="p">:</span> <span class="nx">HorizontalImageChunks</span><span class="p">,</span>
			<span class="nx">VerticalImageChunks</span><span class="p">:</span>   <span class="nx">VerticalImageChunks</span><span class="p">,</span>
			<span class="nx">ChunkImageSize</span><span class="p">:</span>        <span class="nx">ChunkImageSize</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
		<span class="nx">pic</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>

		<span class="nx">done</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span>
		<span class="k">for</span> <span class="k">range</span> <span class="nx">done</span> <span class="p">{</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="o">*</span><span class="nx">saveImage</span> <span class="p">{</span>
			<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
			<span class="nf">saveImageFrom</span><span class="p">(</span><span class="nx">pic</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;bench_%d_%d_%d_w_%d.jpeg&#34;</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">HorizontalImageChunks</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">VerticalImageChunks</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">ChunkImageSize</span><span class="p">,</span> <span class="nx">workers</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">saveImageFrom</span><span class="p">(</span><span class="nx">pic</span> <span class="o">*</span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Picture</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">img</span> <span class="o">:=</span> <span class="nx">image</span><span class="p">.</span><span class="nf">NewRGBA</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nf">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">HorizontalResolution</span><span class="p">(),</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">VerticalResolution</span><span class="p">()))</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">HorizontalImageChunks</span><span class="o">*</span><span class="nx">pic</span><span class="p">.</span><span class="nx">VerticalImageChunks</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetImageOffsetFor</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
		<span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetArea</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">outFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;output file cannot be opened, cause: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">outFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">encodingError</span> <span class="o">:=</span> <span class="nx">jpeg</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">img</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">jpeg</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Quality</span><span class="p">:</span> <span class="mi">90</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">encodingError</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span> <span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">area</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">offsetX</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">x</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">HorizontalResolution</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">VerticalResolution</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">point</span> <span class="o">:=</span> <span class="nx">area</span><span class="p">.</span><span class="nf">GetPoint</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
			<span class="nx">color</span> <span class="o">:=</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="nx">area</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">,</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
			<span class="p">})</span>
			<span class="nx">img</span><span class="p">.</span><span class="nf">SetRGBA</span><span class="p">(</span><span class="nx">offsetX</span><span class="o">+</span><span class="nx">x</span><span class="p">,</span> <span class="nx">offsetY</span><span class="o">+</span><span class="nx">y</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Point</span><span class="p">,</span> <span class="nx">palette</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">maxIterations</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxIterationsColor</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">)</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">==</span> <span class="nx">maxIterations</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">maxIterationsColor</span>
	<span class="p">}</span>
	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">palette</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">palette</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w1</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w2</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w3</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w4</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w5</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w6</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w7</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1024x1024x1w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks512x512x2w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks256x256x4w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks128x128x8w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks64x64x16w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks32x32x32w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks16x16x64w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks8x8x128w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks4x4x256w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks2x2x512w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BenchmarkComplexPictureChunks1x1x1024w8</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nf">benchmarkComplexPictureChunks</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<p>It is important that the caller must read the channel <code>done</code> until the calculation ends because, if there is no receiver, the channel is blocked.</p>

<p>The <code>saveImage</code> is a flag passed to the test command to keep the generated image for each benchmark. This allows to visually verify that the benchmark is actually rendering the right image.</p>

<p>This is the section selected for the benchmarks. I&rsquo;m using a different method to give color to the set this time. I&rsquo;m using a color palette with 7 colors and I assign it based on the number of iterations. <code>color[iterations % len(color)]</code> This is awesome because always give the same color to a section independently of the zoom.</p>

<p><img src="./bench.jpeg" alt="bench" /></p>

<h2 id="mandelbrot-cli">Mandelbrot CLI</h2>

<p>Let&rsquo;s create a CLI to generate awesome images of any given area.</p>

<p>To ease the final usage, I&rsquo;ve simplified the input parameters to some more human-friendly. The default values, generate a global view of the Mandelbrot in a 1920x1920 image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">top</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;top&#34;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s">&#34;Top mandelbrot position&#34;</span><span class="p">)</span>
<span class="nx">left</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;left&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="s">&#34;Left mandelbrot position&#34;</span><span class="p">)</span>
<span class="nx">areaSize</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;areaSize&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#34;From the TopLeft, the size of the complex area&#34;</span><span class="p">)</span>

<span class="nx">imageSize</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;imageSize&#34;</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="s">&#34;Size of the squared image generated in pixels&#34;</span><span class="p">)</span>
<span class="nx">divisions</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;divisions&#34;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s">&#34;Number of divisions to split the work over multiple routines&#34;</span><span class="p">)</span>
<span class="nx">maxIterations</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;maxIterations&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&#34;Maximum number of iterations per point&#34;</span><span class="p">)</span>

<span class="nx">workers</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;workers&#34;</span><span class="p">,</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NumCPU</span><span class="p">(),</span> <span class="s">&#34;Maximum number of iterations per point&#34;</span><span class="p">)</span>
<span class="nx">out</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;out&#34;</span><span class="p">,</span> <span class="s">&#34;mandelbrot.jpg&#34;</span><span class="p">,</span> <span class="s">&#34;output file, it can be png or jpg&#34;</span><span class="p">)</span>
<span class="nx">timeout</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int64</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&#34;Maximum number of seconds to compute, if reached. the program will exit&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>With this flags, I directly call a <code>mandelbot.NewPicture</code> function that accepts this parameters and handles the conversion to the original parameters needed by the <code>mandelbot.Picture</code>. The only thing to adjust is the chunkSize based on the number of divisions to ensure that we draw the same area. The drawback is that we need to carefully select the number of divisions or it will be impossible to split the area in a whole number of divisions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">pic</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nf">NewPicture</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="o">*</span><span class="nx">left</span><span class="p">,</span> <span class="o">*</span><span class="nx">top</span><span class="p">),</span> <span class="o">*</span><span class="nx">areaSize</span><span class="p">,</span> <span class="o">*</span><span class="nx">imageSize</span><span class="p">,</span> <span class="o">*</span><span class="nx">divisions</span><span class="p">,</span> <span class="o">*</span><span class="nx">maxIterations</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">NewPicture</span><span class="p">(</span><span class="nx">topLeft</span> <span class="kt">complex128</span><span class="p">,</span> <span class="nx">chunkSize</span> <span class="kt">float64</span><span class="p">,</span> <span class="nx">imageSize</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">divisions</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxIterations</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Picture</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">imageSize</span><span class="o">%</span><span class="nx">divisions</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;WARNING: ImageSize %d can&#39;t be divided in %d divisions, The final image will be smaller&#34;</span><span class="p">,</span> <span class="nx">imageSize</span><span class="p">,</span> <span class="nx">divisions</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">chunkImageSize</span> <span class="o">:=</span> <span class="nx">imageSize</span> <span class="o">/</span> <span class="nx">divisions</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Picture</span><span class="p">{</span>
		<span class="nx">TopLeft</span><span class="p">:</span>               <span class="nx">topLeft</span><span class="p">,</span>
		<span class="nx">MaxIterations</span><span class="p">:</span>         <span class="nx">maxIterations</span><span class="p">,</span>
		<span class="nx">ChunkSize</span><span class="p">:</span>             <span class="nx">chunkSize</span> <span class="o">/</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">divisions</span><span class="p">),</span>
		<span class="nx">HorizontalImageChunks</span><span class="p">:</span> <span class="nx">divisions</span><span class="p">,</span>
		<span class="nx">VerticalImageChunks</span><span class="p">:</span>   <span class="nx">divisions</span><span class="p">,</span>
		<span class="nx">ChunkImageSize</span><span class="p">:</span>        <span class="nx">chunkImageSize</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>After calling <code>pic.Init()</code>, we can call <code>pic.CalculateAsync()</code> to get the <code>doneIndex</code> channel that will notify us about the progress. As we need a little bit of setup with a context and a picture. I will wrap the calculation in a function <code>Calculate</code> that accepts the <code>pic</code> and returns an <code>image.RGBA</code> ready to be exported.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">timeout</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">pic</span> <span class="o">*</span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Picture</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">ctxCancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">timeout</span><span class="p">))</span>
	<span class="k">defer</span> <span class="nf">ctxCancel</span><span class="p">()</span>

	<span class="nx">doneIndex</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span>
	<span class="nx">img</span> <span class="o">:=</span> <span class="nx">image</span><span class="p">.</span><span class="nf">NewRGBA</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nf">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">HorizontalResolution</span><span class="p">(),</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">VerticalResolution</span><span class="p">()))</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="k">return</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">doneIndex</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Finished&#34;</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">img</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Index %d done&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
			<span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetImageOffsetFor</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
			<span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetArea</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>The <code>mandelbot.Picture</code> provides utility method that return information about the final image dimensions. This way, I can prepare the final image. In the for loop we wait for updates from the calculation and call a function to paint the finished Area into the final image. The method <code>picture.GetImageOffserFor</code> accepts an index and returns the <code>x,y</code> positions in the resolution of the final image. If the context is cancelled. the <code>Calculate</code> function returns a partial image and the error that canceled the context. This way, if the context is cancelled. The function returns almost immediately. This could be a serious bug because workers will never be able to finish their work. But it is not a problem here because the program will just save the image and exit. I will solve this in future posts.</p>

<p>Let&rsquo;s take a look into the <code>paintAreaInImage</code> function. It&rsquo;s purpose is to iterate over all the pixels in the area, assign them a color, and add it to the final Image. The function <code>getColor</code> accepts <code>(point mandelbrot.Point, palette []color.RGBA, maxIterations int, maxIterationsColor color.RGBA)</code>  The color is chosen by dividing the iterations over the len of the palette. This ensures that we the next color for every iterations and that we loop back to the first one when the length is reached. The maxIterations is needed to paint the &ldquo;Unknown&rdquo; area of a different color. In this case, Black color.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span> <span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">area</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">offsetX</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">x</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">HorizontalResolution</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">VerticalResolution</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">point</span> <span class="o">:=</span> <span class="nx">area</span><span class="p">.</span><span class="nf">GetPoint</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
			<span class="nx">color</span> <span class="o">:=</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="nx">area</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">,</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
			<span class="p">})</span>
			<span class="nx">img</span><span class="p">.</span><span class="nf">SetRGBA</span><span class="p">(</span><span class="nx">offsetX</span><span class="o">+</span><span class="nx">x</span><span class="p">,</span> <span class="nx">offsetY</span><span class="o">+</span><span class="nx">y</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Point</span><span class="p">,</span> <span class="nx">palette</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">maxIterations</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxIterationsColor</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">)</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">==</span> <span class="nx">maxIterations</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">maxIterationsColor</span>
	<span class="p">}</span>
	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">palette</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">palette</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>When the function <code>Calculate</code> returns, we have a img object that must be saved to a file. If you pay attention to the parameters accepted by the program, it says that accepts png and jpeg formats. To do so, we can use the function <code>filepath.Ext</code> to find the extension of the file name. As go already provides codecs for jpeg and png. The code is straight forward.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">outFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">out</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;output file cannot be opened, cause: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">outFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="k">switch</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Ext</span><span class="p">(</span><span class="o">*</span><span class="nx">out</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="s">&#34;.jpg&#34;</span><span class="p">,</span> <span class="s">&#34;.jpeg&#34;</span><span class="p">:</span>
	<span class="nx">encodingError</span> <span class="o">:=</span> <span class="nx">jpeg</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">img</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">jpeg</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Quality</span><span class="p">:</span> <span class="mi">90</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">encodingError</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="k">case</span> <span class="s">&#34;.png&#34;</span><span class="p">:</span>
	<span class="nx">encodingError</span> <span class="o">:=</span> <span class="nx">png</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">img</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">encodingError</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<div class="expand">
    <div class="expand-label" style="cursor: pointer;"
        onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
        <i style="font-size:x-small;" class="fas fa-chevron-right"></i>
        <span>
            
            
            &gt; Click here to see all code
            
        </span>
    </div>
    <div class="expand-content" style="display: none;">
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;image&#34;</span>
	<span class="s">&#34;image/color&#34;</span>
	<span class="s">&#34;image/jpeg&#34;</span>
	<span class="s">&#34;image/png&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;path/filepath&#34;</span>
	<span class="s">&#34;runtime&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/metalblueberry/mandelbrot/mandelbrot&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">top</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;top&#34;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s">&#34;Top mandelbrot position&#34;</span><span class="p">)</span>
	<span class="nx">left</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;left&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="s">&#34;Left mandelbrot position&#34;</span><span class="p">)</span>
	<span class="nx">areaSize</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;areaSize&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#34;From the TopLeft, the size of the complex area&#34;</span><span class="p">)</span>

	<span class="nx">imageSize</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;imageSize&#34;</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="s">&#34;Size of the squared image generated in pixels&#34;</span><span class="p">)</span>
	<span class="nx">divisions</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;divisions&#34;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s">&#34;Number of divisions to split the work over multiple routines&#34;</span><span class="p">)</span>
	<span class="nx">maxIterations</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;maxIterations&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&#34;Maximum number of iterations per point&#34;</span><span class="p">)</span>

	<span class="nx">workers</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;workers&#34;</span><span class="p">,</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NumCPU</span><span class="p">(),</span> <span class="s">&#34;Maximum number of iterations per point&#34;</span><span class="p">)</span>
	<span class="nx">out</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;out&#34;</span><span class="p">,</span> <span class="s">&#34;mandelbrot.jpg&#34;</span><span class="p">,</span> <span class="s">&#34;output file, it can be png or jpg&#34;</span><span class="p">)</span>
	<span class="nx">timeout</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int64</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&#34;Maximum number of seconds to compute, if reached. the program will exit&#34;</span><span class="p">)</span>

	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Start&#34;</span><span class="p">)</span>

	<span class="nx">pic</span> <span class="o">:=</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nf">NewPicture</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="o">*</span><span class="nx">left</span><span class="p">,</span> <span class="o">*</span><span class="nx">top</span><span class="p">),</span> <span class="o">*</span><span class="nx">areaSize</span><span class="p">,</span> <span class="o">*</span><span class="nx">imageSize</span><span class="p">,</span> <span class="o">*</span><span class="nx">divisions</span><span class="p">,</span> <span class="o">*</span><span class="nx">maxIterations</span><span class="p">)</span>
	<span class="nx">pic</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Calculation started&#34;</span><span class="p">)</span>

	<span class="nx">img</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Calculate</span><span class="p">(</span><span class="o">*</span><span class="nx">timeout</span><span class="p">,</span> <span class="o">*</span><span class="nx">workers</span><span class="p">,</span> <span class="nx">pic</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Calculation failed, image is not complete. cause: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">outFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">*</span><span class="nx">out</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;output file cannot be opened, cause: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">outFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="k">switch</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Ext</span><span class="p">(</span><span class="o">*</span><span class="nx">out</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="s">&#34;.jpg&#34;</span><span class="p">,</span> <span class="s">&#34;.jpeg&#34;</span><span class="p">:</span>
		<span class="nx">encodingError</span> <span class="o">:=</span> <span class="nx">jpeg</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">img</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">jpeg</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Quality</span><span class="p">:</span> <span class="mi">90</span><span class="p">})</span>
		<span class="k">if</span> <span class="nx">encodingError</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="s">&#34;.png&#34;</span><span class="p">:</span>
		<span class="nx">encodingError</span> <span class="o">:=</span> <span class="nx">png</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">img</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">encodingError</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Calculate</span><span class="p">(</span><span class="nx">timeout</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">workers</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">pic</span> <span class="o">*</span><span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Picture</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">ctxCancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">timeout</span><span class="p">))</span>
	<span class="k">defer</span> <span class="nf">ctxCancel</span><span class="p">()</span>
	<span class="nx">doneIndex</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">CalculateAsync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">workers</span><span class="p">)</span>
	<span class="nx">img</span> <span class="o">:=</span> <span class="nx">image</span><span class="p">.</span><span class="nf">NewRGBA</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nf">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">HorizontalResolution</span><span class="p">(),</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">VerticalResolution</span><span class="p">()))</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="k">return</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
		<span class="k">case</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">doneIndex</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Finished&#34;</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">img</span><span class="p">,</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Index %d done&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
			<span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="o">:=</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetImageOffsetFor</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
			<span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nf">GetArea</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">offsetX</span><span class="p">,</span> <span class="nx">offsetY</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">paintAreaInImage</span><span class="p">(</span><span class="nx">img</span> <span class="o">*</span><span class="nx">image</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">area</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Area</span><span class="p">,</span> <span class="nx">offsetX</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">offsetY</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">x</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">HorizontalResolution</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">y</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="p">&lt;</span> <span class="nx">area</span><span class="p">.</span><span class="nx">VerticalResolution</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">point</span> <span class="o">:=</span> <span class="nx">area</span><span class="p">.</span><span class="nf">GetPoint</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
			<span class="nx">color</span> <span class="o">:=</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
					<span class="nx">R</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">G</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">B</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
					<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span> <span class="nx">area</span><span class="p">.</span><span class="nx">MaxIterations</span><span class="p">,</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">{</span>
				<span class="nx">A</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span>
			<span class="p">})</span>
			<span class="nx">img</span><span class="p">.</span><span class="nf">SetRGBA</span><span class="p">(</span><span class="nx">offsetX</span><span class="o">+</span><span class="nx">x</span><span class="p">,</span> <span class="nx">offsetY</span><span class="o">+</span><span class="nx">y</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getColor</span><span class="p">(</span><span class="nx">point</span> <span class="nx">mandelbrot</span><span class="p">.</span><span class="nx">Point</span><span class="p">,</span> <span class="nx">palette</span> <span class="p">[]</span><span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">maxIterations</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">maxIterationsColor</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">)</span> <span class="nx">color</span><span class="p">.</span><span class="nx">RGBA</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">==</span> <span class="nx">maxIterations</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">maxIterationsColor</span>
	<span class="p">}</span>
	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">point</span><span class="p">.</span><span class="nf">Iterations</span><span class="p">()</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">palette</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">palette</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<h2 id="conclusion">Conclusion</h2>

<p>This has been really interesting. I was not expecting a x6 speed but looks like I was wrong. I think that the optimal number of divisions comes from a tread-off between the capacity to split the work over multiple cores and the extra time required to send data over channels. I would like to benchmark the code again and see where is the bottle neck for each configuration.</p>

<p>I think that the next project will be to create a mandelbrot-server that provides a webpage when the user will be able to zoom in the set dynamically. It would be awesome!</p>

<p>Checkout the whole code in the repository. Here is the <a href="https://github.com/MetalBlueberry/go-mandelbrot/releases/tag/2019-11-17_mandelbrot_parallel_computation">link</a> to the tag that hold the code at this moment. You can also <a href="https://github.com/MetalBlueberry/go-mandelbrot/releases/download/2019-11-17_mandelbrot_parallel_computation/mandelbrot">download the binary</a> for linux! just in case you want to run it without installing go.</p>

<p>Thank you for reading and feel free to leave a comment bellow, I will be really happy to hear from you.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://golang.org/pkg/context/">Go context.Context</a></li>
<li><a href="https://golang.org/pkg/sync/#example_WaitGroup">Go sync.WaitGroup</a></li>
<li><a href="https://golang.org/pkg/image/">Go image</a></li>
<li><a href="https://tour.golang.org/concurrency/2">TourOfGo Channels</a></li>
<li><a href="https://medium.com/rungo/anatomy-of-channels-in-go-concurrency-in-go-1ec336086adb">Medium Anatomy of channels</a></li>
</ul>
  </div>

  
<footer class="post-footer">
    <div class="post-tags">
      <a href="/tags/go/">go</a>
      <a href="/tags/mandelbrot/">mandelbrot</a>
      </div>
    <nav class="post-nav">
      <a class="prev" href="/post/blog/2019-11-24_avoid_github_government_block/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Avoid Github Government Block</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
      <a class="next" href="/post/blog/2019-11-03_leadership_training/">
        <span class="next-text nav-default">Leadership Training</span>
        <span class="next-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav>
  </footer>
</article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="MetalBlueberry/MetalBlueberry.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:metalblueberry@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/MetalBlueberry" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.linkedin.com/in/victorperezdomingo/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/MetalBlueberry" class="iconfont icon-github" title="github"></a>
  <a href="https://metalblueberry.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">MetalBlueberry</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-150427130-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
