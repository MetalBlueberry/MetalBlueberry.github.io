<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Mandelbrot Parallel Computation&nbsp;&ndash;&nbsp;MetalBlueberry</title><link rel="stylesheet" href="/css/core.min.60b999055342ab7932e4aa314d0695544a6f92a06cc9e66ba06a256dd171de65ceaa852aed469a1e8e3cd6448118d1bb.css" integrity="sha384-YLmZBVNCq3ky5KoxTQaVVEpvkqBsyeZroGolbdFx3mXOqoUq7UaaHo481kSBGNG7"><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="alternate icon" href="/favicon.ico">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mandelbrot Parallel Computation"/>
<meta name="twitter:description" content="This post explains how to parallelize the computational task of the Mandelbrot set and generate a terminal tool to generate images."/>

<meta property="og:title" content="Mandelbrot Parallel Computation" />
<meta property="og:description" content="This post explains how to parallelize the computational task of the Mandelbrot set and generate a terminal tool to generate images." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://metalblueberry.github.io/post/howto/2019-11-17_mandelbrot_parallel_computation/" />
<meta property="article:published_time" content="2019-11-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-10T11:39:35+02:00" />

<meta name="author" content="MetalBlueberry">

<script src="https://cdn.plot.ly/plotly-1.50.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<body>
    <div class="base-body"><section id="header" class="site header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><img class="site logo" src="/favicon.svg" alt /><span class="site name">MetalBlueberry</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/about">About</a><a class="nav item" href="/social">Follow me</a></nav></div></span></div><div class="site slogan"><span class="title">A passionate programmer</span></div></section><div id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Mandelbrot Parallel Computation</h1><p class="article date">November 17, 2019<span class="lastmod"> â€¢ edited April 10, 2020</span></p></section><article class="article markdown-body"><p>This post explains how to parallelize the computational task of the Mandelbrot set and generate a terminal tool to generate images.</p>
<div class="admonition warning"><p class="admonition-title">warning</p>
<p>You should read <a href="/post/howto/2019-11-01_go-cpu-profiling/">the previous post</a> to understand the context of this post.</p>
</div>
<p>We left it after improving drastically the performance of our code by running benchmarks and drawing flame graphs with pprof. The problem is we almost hit the limit of the optimization following this line. Now we are going to take advantage of the tools provided by Go to implement a parallel computation that will reduce the total computational time.</p>
<h2 id="introduction">Introduction</h2>
<p>The first thing to do is to identify the parts of the computation that can be calculated independently from the others. Luckily, in the Mandelbrot set, the calculation if each point belongs to the set, is completely independent from other points. This makes really simple to split the work over multiple cores.</p>
<p>Next think to ask ourself is, is it worth to spawn a goroutine for each point? Reading documentation about go internals, this can be done, but it is not a good practice. This is because the task that we are performing is CPU intensive and this will effectively limit the maximum number of goroutines running to the maximum number of available cores in the system. So, theoretically, the maximum number of routines should be the number of cores.</p>
<p>Knowing that this encourages a producer-consumer pattern. The next questions is, what is the optimal way to split the tasks? we know that the calculation for each point is the minium part that can be calculated independently. Should we group some points as a single task? if yes, how many? I think the best way to answer this question is to benchmark the code.</p>
<div class="admonition info"><p class="admonition-title">Info</p>
<p>The idea that I&rsquo;ve in mind comes from how Blender renders complex images. here is a gif of a render divided in little squares.</p>
<p><a target="_blank" rel="noopener noreferrer" 
  href="https://devtalk.blender.org/uploads/default/original/1X/79d5a6dd63de7dead05d73e29ed263f66f43af16.gif#center"><img  src="https://devtalk.blender.org/uploads/default/original/1X/79d5a6dd63de7dead05d73e29ed263f66f43af16.gif#center"
        alt="blenderrender"/></a></p>
</div>
<h2 id="the-mandelbrot-picture-struct">The Mandelbrot Picture Struct</h2>
<p>To hold the data together and to coordinate the calculation, I&rsquo;ve created a new structure called Picture. Then, we have a <code>mandelbot.Point</code>, as the minimal computational unit. <code>mandelbot.Area</code>, as a group of Points that will be calculated together. And <code>mandelbot.Picture</code> as a group of Areas.</p>
<p>![Picture Description](./Picture Description.svg#center)</p>
<p>The previous picture is a visual representation of what the variables of the Picture structure actually mean. Blue ones are in pixels and represent the final image that will be build. The red ones are in float point precision and represent the mandelbrot area. The axis are just there as an orientation</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> Picture <span style="color:#8be9fd;font-style:italic">struct</span> {
	TopLeft       <span style="color:#8be9fd">complex128</span>
	ChunkSize     <span style="color:#8be9fd">float64</span>
	MaxIterations <span style="color:#8be9fd">int</span>

	HorizontalImageChunks <span style="color:#8be9fd">int</span>
	VerticalImageChunks   <span style="color:#8be9fd">int</span>
	ChunkImageSize        <span style="color:#8be9fd">int</span>

	areas []Area
}
</code></pre></td></tr></table>
</div>
</div><p>The strategy of storing 2D data in a single array is also being used here with exactly the same approach. To initialize the data, I also have the <code>picture.Init</code> function that initializes the picture and all the recursive areas. This function performs the calculation to assign to each area the corresponding section of the complex area that must render. Based on the x,y position and the ChunkSize, it is easy to calculate the TopLeft and BottomRight of each area. The only tricky thing is that to move from TopToBottom, we need to subtract instead of adding. thats why you see the minus sign next to the imaginary parts. Also, after creating the Area with the calculated values, there is a call to <code>area.Init</code> to guarantee that everything is initialised.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Init</span>() {
	p.areas = <span style="color:#8be9fd;font-style:italic">make</span>([]Area, p.HorizontalImageChunks<span style="color:#ff79c6">*</span>p.VerticalImageChunks)
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.areas); i<span style="color:#ff79c6">++</span> {
		x, y <span style="color:#ff79c6">:=</span> p.<span style="color:#50fa7b">ForIndex</span>(i)
		areaTopLeft <span style="color:#ff79c6">:=</span> p.TopLeft <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">complex</span>(p.ChunkSize<span style="color:#ff79c6">*</span><span style="color:#8be9fd;font-style:italic">float64</span>(x), <span style="color:#ff79c6">-</span>p.ChunkSize<span style="color:#ff79c6">*</span><span style="color:#8be9fd;font-style:italic">float64</span>(y))
		areaBottomRight <span style="color:#ff79c6">:=</span> areaTopLeft <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">complex</span>(p.ChunkSize, <span style="color:#ff79c6">-</span>p.ChunkSize)

		p.areas[i] = Area{
			TopLeft:              areaTopLeft,
			BottomRight:          areaBottomRight,
			HorizontalResolution: p.ChunkImageSize,
			VerticalResolution:   p.ChunkImageSize,
			MaxIterations:        p.MaxIterations,
		}
		p.areas[i].<span style="color:#50fa7b">Init</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><h2 id="calculation">Calculation</h2>
<p>Let&rsquo;s start with a simple loop to calculate all the areas inside the Picture. It will look like this.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>() {
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.areas); i<span style="color:#ff79c6">++</span> {
		p.areas[i].<span style="color:#50fa7b">Calculate</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><p>The firs way is to decide how are we going to split the areas slice for the workers. <strong>My first attempt</strong> was to slice the slice intro subparts with the same number of elements, but this approach has a few drawbacks. First, when the operation len(p.areas)/workers generates a remained, it becomes tricky which worker should do it. Also, not all the areas require the same number of iterations, so this approach generates unbalanced workers. This is how the code looks like</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>(workerCount <span style="color:#8be9fd">int</span>) {
	works <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">splitWorks</span>(p.areas, workerCount)

	<span style="color:#ff79c6">for</span> w <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; w &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.works); w<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">doWork</span>(works[w])
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">splitWorks</span>(areas []Area, workerCount <span style="color:#8be9fd">int</span>) (works [][]Area) {
	<span style="color:#6272a4">// Split []Area in [][]Area, omitted for simplicity
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(areas []Area){
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.areas); i<span style="color:#ff79c6">++</span> {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><h3 id="task-synchronization-with-syncwaitgroup">Task Synchronization With sync.WaitGroup</h3>
<p>The firs issue with this code is that the Calculate function no longer blocks the code and it exist before the computation finishes. To address this issue, we have <code>sync.WaitGroup</code>. A wait group is a simple structure that keeps track of the works that are being executed in parallel and allows easy synchronization to wait for all of them to finish. After creating the <code>wg := &amp;sync.WaitGroup{}</code>, you must call to <code>wg.Add</code> with the number of expected workers and then, call <code>wg.Done</code> when each of the workers finish. This allows to wait for all of them to exit with a simple call to <code>wg.Wait</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>(workerCount <span style="color:#8be9fd">int</span>) {
	<span style="color:#6272a4">// Setup wg and WorkerCount
</span><span style="color:#6272a4"></span>	wg <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>sync.WaitGroup{}
	wg.<span style="color:#50fa7b">Add</span>(workerCount)

	works <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">splitWorks</span>(p.areas, workers)

	<span style="color:#ff79c6">for</span> w <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; w &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.works); w<span style="color:#ff79c6">++</span> {
		<span style="color:#6272a4">// send the wg to the worker
</span><span style="color:#6272a4"></span>		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">doWork</span>(wg, works[w])
	}
	<span style="color:#6272a4">// Wait for all the workers to finish
</span><span style="color:#6272a4"></span>	wg.<span style="color:#50fa7b">Wait</span>()
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">splitWorks</span>(areas []Area, workers <span style="color:#8be9fd">int</span>) (works [][]Area) {
	<span style="color:#6272a4">// Split []Area in [][]Area, omitted for simplicity
</span><span style="color:#6272a4"></span>}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup, areas []Area){
	<span style="color:#6272a4">// when the work is done, notify the wg
</span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#8be9fd;font-style:italic">len</span>(p.areas); i<span style="color:#ff79c6">++</span> {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><h3 id="work-queue">Work Queue</h3>
<p>I&rsquo;m not really happy with the approach of splitting the work for the various reasons I&rsquo;ve described before. In the <strong>second attempt</strong>, I decided to generate queue with all the areas pending to be processed and the workers just pick new jobs from there until all are done. Let&rsquo;s create the function to initialize the queue based on a channel.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">workQueue</span>(workCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	next <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; workCount; i<span style="color:#ff79c6">++</span> {
			next <span style="color:#ff79c6">&lt;-</span> i
		}
		<span style="color:#8be9fd;font-style:italic">close</span>(next)
	}()
	<span style="color:#ff79c6">return</span> next
}
</code></pre></td></tr></table>
</div>
</div><p>Given a workCount, this function returns a channel that returns sequentially the numbers from 0 to workCount - 1. This fits perfectly to the indexes of a slice and this is how we are going to use it. First, we have to modify our workers to accept the work from a channel.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup, areas []Area, next <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>){
	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()

	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> next {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><p>The range function used over a channel, returns elements until the channel is closed. This is really handy to implement the work queue. The code looks even easier than before. Let&rsquo;s see all together.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>(workerCount <span style="color:#8be9fd">int</span>) {
	wg <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>sync.WaitGroup{}
	wg.<span style="color:#50fa7b">Add</span>(workerCount)

	next <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">workQueue</span>(<span style="color:#8be9fd;font-style:italic">len</span>(p.areas))

	<span style="color:#ff79c6">for</span> worker <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; worker &lt; workerCount; worker<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">doWork</span>(wg, p.areas, next)
	}

	wg.<span style="color:#50fa7b">Wait</span>()

}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">workQueue</span>(workCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	next <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; workCount; i<span style="color:#ff79c6">++</span> {
			next <span style="color:#ff79c6">&lt;-</span> i
		}
		<span style="color:#8be9fd;font-style:italic">close</span>(next)
	}()
	<span style="color:#ff79c6">return</span> next
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup, areas []Area, next <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> next {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><h3 id="work-progress-report">Work Progress Report</h3>
<p>Remember when we tried to implement progress reporting using channels and this drastically reduced the performance? well, It was clearly over engineered to report every iteration of the calculation. But with this new structure, it would be easy and cheap to report each time one of the workers finish the calculation of an area. This will enable potential consumers to start drawing it or just notify us of the global process. I will be using the same approach as the workQueue. The calculate function will return a channel that reports the updates. To keep things clear, I will also create the method <code>picture.CalculateAsync</code> to create the channel for the consumer.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>(ctx context.Context, workerCount <span style="color:#8be9fd">int</span>, doneIndex <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
	wg <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>sync.WaitGroup{}
	wg.<span style="color:#50fa7b">Add</span>(workerCount)

	next <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">workQueue</span>(ctx, <span style="color:#8be9fd;font-style:italic">len</span>(p.areas))

	<span style="color:#ff79c6">for</span> worker <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; worker &lt; workerCount; worker<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">doWork</span>(wg, p.areas, next, doneIndex)
	}

	wg.<span style="color:#50fa7b">Wait</span>()

	<span style="color:#8be9fd;font-style:italic">close</span>(doneIndex)
}

<span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">CalculateAsync</span>(ctx context.Context, workerCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	doneIndex <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> p.<span style="color:#50fa7b">Calculate</span>(ctx, workerCount, doneIndex)
	<span style="color:#ff79c6">return</span> doneIndex
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">workQueue</span>(ctx context.Context, workCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	next <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; workCount; i<span style="color:#ff79c6">++</span> {
			next <span style="color:#ff79c6">&lt;-</span> i
		}
		<span style="color:#8be9fd;font-style:italic">close</span>(next)
	}()
	<span style="color:#ff79c6">return</span> next
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup, areas []Area, next <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, doneIndex <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> next {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
		doneIndex <span style="color:#ff79c6">&lt;-</span> i
	}
}
</code></pre></td></tr></table>
</div>
</div><h3 id="calculation-execution-context">Calculation Execution Context</h3>
<p>The doneIndex channel carries the index of the Area that has been finished. The consumer only needs to wait for a number to arrive, and then, get the corresponding Area from the Picture. We will see this code later. Now we have to add one last thing to this code. The calculation can take a long time or we may require to stop it before finishing. To implement this, we have the <code>context.Context</code>. From the docs <em>A Context carries a deadline, a cancellation signal, and other values across API boundaries.</em> let&rsquo;s see how the code looks like.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">Calculate</span>(ctx context.Context, workerCount <span style="color:#8be9fd">int</span>, doneIndex <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
	wg <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>sync.WaitGroup{}
	wg.<span style="color:#50fa7b">Add</span>(workerCount)

	next <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">workQueue</span>(ctx, <span style="color:#8be9fd;font-style:italic">len</span>(p.areas))

	<span style="color:#ff79c6">for</span> worker <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; worker &lt; workerCount; worker<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">go</span> <span style="color:#50fa7b">doWork</span>(wg, p.areas, next, doneIndex)
	}

	wg.<span style="color:#50fa7b">Wait</span>()

	<span style="color:#8be9fd;font-style:italic">close</span>(doneIndex)
}

<span style="color:#8be9fd;font-style:italic">func</span> (p <span style="color:#ff79c6">*</span>Picture) <span style="color:#50fa7b">CalculateAsync</span>(ctx context.Context, workerCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	doneIndex <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> p.<span style="color:#50fa7b">Calculate</span>(ctx, workerCount, doneIndex)
	<span style="color:#ff79c6">return</span> doneIndex
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">workQueue</span>(ctx context.Context, workCount <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span> {
	next <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">make</span>(<span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>)
	<span style="color:#ff79c6">go</span> <span style="color:#8be9fd;font-style:italic">func</span>() {
		<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; workCount; i<span style="color:#ff79c6">++</span> {
			<span style="color:#ff79c6">select</span> {
			<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
				<span style="color:#ff79c6">return</span>
			<span style="color:#ff79c6">case</span> next <span style="color:#ff79c6">&lt;-</span> i:
			}
		}
		<span style="color:#8be9fd;font-style:italic">close</span>(next)
	}()
	<span style="color:#ff79c6">return</span> next
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">doWork</span>(wg <span style="color:#ff79c6">*</span>sync.WaitGroup, areas []Area, next <span style="color:#ff79c6">&lt;-</span><span style="color:#8be9fd;font-style:italic">chan</span> <span style="color:#8be9fd">int</span>, doneIndex <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">defer</span> wg.<span style="color:#50fa7b">Done</span>()
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> next {
		areas[i].<span style="color:#50fa7b">Calculate</span>()
		doneIndex <span style="color:#ff79c6">&lt;-</span> i
	}
}
</code></pre></td></tr></table>
</div>
</div><p>So the tricky thing here is that the workQueue now has two options. A. Publish a new work to be done to the <code>next</code> channel. B. receive a <code>ctx.Done</code> signal and close the <code>next</code> channel. When B happens. this will stop the workers after they finish the current task. This is not the ideal situation because an external user will expect the function to return almost immediately after context cancellation. The problem is that achieving this, can be a little more trick because we cannot just cancel a running goroutine. Also, we cannot close the <code>doneIndex</code> channel until all the workers have finished their work because, if the channel is closed, the workers will panic when publishing the index after calculation. Nevertheless, It is possible to handle such case with a similar select statement to the one used in the <code>workerQueue</code> and adding another go routine in the calculate function to listen for the <code>wg.Wait()</code>. But I think this is too complex for this case. so I will keep it like this for now.</p>
<h2 id="configuration-and-benchmarks">Configuration And Benchmarks</h2>
<p>We have everything ready run our code in parallel, but there are a lot of different setting configurations that can affect the performance of the calculation. The best way to find the appropriate configuration is to run benchmarks and see where the performance is better.</p>
<p>This is the list of parameters that we can modify to change how the work is going to be processed by the workers.</p>
<ul>
<li>Image dimensions
<ul>
<li>HorizontalImageChunks</li>
<li>VerticalImageChunks</li>
<li>ChunkImageSize</li>
</ul>
</li>
<li>Workers</li>
</ul>
<p>To keep a constant image size, the following operation must be constant.</p>
<p>$$HorizontalImageChunks<em>VerticalImageChunks</em>ChunkImageSize^2$$</p>
<p>Now we need to choose an image size and try all the combinations of these values. I&rsquo;ve started with an image of 1024x1024 in the Mandelbrot area <code>topLeft:(-1.401854499759, -0.000743603637), bottomRight: (âˆ’1,180199459759,âˆ’0,222398643637)</code>. The most fragmented case is when I divide the image in 1024x1024 areas of 1 pixel and the less fragmented is just 1 area of 1024x1024 pixels. In the following graph you can see the benchmark results for all the power of 2 combinations from the most fragmented to the less fragmented. In the X axis, the numbers of the previous multiplication. in the Y axis, the s/op returned by the benchmark.  The Y axis is in logarithmic scale to improve the visualization. You can hover the mouse over any point to see the exact value. The horizontal lines represent the optimal speed based on the 1 worker benchmark. is expected to get x2 x3 x4 etc&hellip; speed for each extra worker. You also need to know that my computer has 6 cores.</p>
<div class="figure">
<div class="figure-plot" id="figure1">
	Code could not finish, this are some reasons why this happen.
	- Plot name not defined. The first parameter of the shortcode is the name.
	- There is a syntax error. check browser console.
</div>
<script>
  function draw(){
	test = document.getElementById("figure1");
	if (test == null){
		console.log("The plot name is not defined")
		return
	}

	fig = null
	
fig = {"data":[{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[5.319377513,3.730183194,3.492960513,3.416568462,3.406160365,3.404795796,3.401629099,3.403963371,3.406568944,3.403851128,3.401489335],"name":"1 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[5.105426336,2.403512541,1.769243872,1.720678808,1.705878765,1.702246865,1.705907853,1.731687894,1.819791773,1.954560985,3.404077505],"name":"2 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[4.665434148,1.840141806,1.23159353,1.156602142,1.139298289,1.135465838,1.145931396,1.190932724,1.324346159,1.955651422,3.401555276],"name":"3 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[3.277424857,1.508889857,1.000251994,0.877004851,0.855757891,0.851836168,0.859728354,0.902649372,1.012687753,1.955834209,3.404003372],"name":"4 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[2.687810723,1.299930746,0.848919389,0.71687461,0.697146793,0.686797944,0.695021475,0.733307298,0.782258103,1.958691928,3.406197102],"name":"5 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[2.419063112,1.172598442,0.770078822,0.636418239,0.59517132,0.58758251,0.598871324,0.655497364,0.722161112,1.955789037,3.40305645],"name":"6 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[1.991583443,1.033091053,0.712726608,0.605582734,0.578420338,0.577574125,0.580463384,0.652894185,0.691949137,1.970116638,3.452580344],"name":"7 workers"},{"x":["1024x1024x1","512x512x2","256x256x4","128x128x8","64x64x16","32x32x32","16x16x64","8x8x128","4x4x256","2x2x512","1x1x1024"],"y":[1.942149854,0.947873093,0.683032395,0.605635427,0.575207906,0.573205018,0.580969231,0.653116053,0.72285752,1.954330764,3.407772597],"name":"8 workers"}],"layout":{"title":"Benchmark results","yaxis":{"title":"s/op","type":"log","autorange":true},"shapes":[{"type":"line","xref":"paper","yref":"y","y0":3.40394218,"x0":0,"y1":3.40394218,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":1.70197109,"x0":0,"y1":1.70197109,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":1.1346473933333334,"x0":0,"y1":1.1346473933333334,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.850985545,"x0":0,"y1":0.850985545,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.680788436,"x0":0,"y1":0.680788436,"x1":1,"line":{"width":1}},{"type":"line","xref":"paper","yref":"y","y0":0.5673236966666667,"x0":0,"y1":0.5673236966666667,"x1":1,"line":{"width":1}}],"margin":{"l":25,"r":5,"b":75,"t":50,"pad":4}},"config":{"responsive":true}}


	if (!fig) {
		test.innerText = "ERROR: fig variable is not defined"
		return
	}
	test.innerText = null
	Plotly.plot(test ,fig);
  }
  draw()
</script>
</div>
<p>There a few interesting things in this graph.</p>
<ol>
<li>If the image only contains 1 area, the benchmark is independent of the number of cores. You can see this at the right point of the graph.</li>
<li>If the image is divided in too many areas. The performance is deteriorated for all the setups. This is the left part of the graph.</li>
<li>All the lines have a parabolic shape with a minimum in 32x32x32. This is the best setup for my computer.</li>
<li>Selecting the minimum point, the performance is doubled almost perfectly for each worker added until reaching the system limit of 6 cores.</li>
<li>The performance still increases after 6 workers, but it never reaches the x6 speed.</li>
<li>The performance in 512x512x2 is the same after the 2nd worker. I think this is because not all the sections in the set are equally expensive to calculate. The hardest one is closer to the right top because is almost all black.</li>
</ol>
<p>Here is the code that runs the benchmarks.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b <span style="color:#ff79c6">*</span>testing.B, HorizontalImageChunks, VerticalImageChunks, ChunkImageSize, workers <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; b.N; i<span style="color:#ff79c6">++</span> {
		b.<span style="color:#50fa7b">StopTimer</span>()
		pic <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>mandelbrot.Picture{
			TopLeft:               <span style="color:#8be9fd;font-style:italic">complex</span>(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1.401854499759</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">0.000743603637</span>),
			MaxIterations:         <span style="color:#bd93f9">3534</span>,
			ChunkSize:             <span style="color:#bd93f9">0.00021646</span> <span style="color:#ff79c6">*</span> <span style="color:#8be9fd;font-style:italic">float64</span>(ChunkImageSize),
			HorizontalImageChunks: HorizontalImageChunks,
			VerticalImageChunks:   VerticalImageChunks,
			ChunkImageSize:        ChunkImageSize,
		}
		ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">Background</span>()
		pic.<span style="color:#50fa7b">Init</span>()
		b.<span style="color:#50fa7b">StartTimer</span>()

		done <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">CalculateAsync</span>(ctx, workers)
		<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">range</span> done {

		}
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">*</span>saveImage {
			b.<span style="color:#50fa7b">StopTimer</span>()
			<span style="color:#50fa7b">saveImageFrom</span>(pic, fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;bench_%d_%d_%d_w_%d.jpeg&#34;</span>, pic.HorizontalImageChunks, pic.VerticalImageChunks, pic.ChunkImageSize, workers))
		}
	}
}
</code></pre></td></tr></table>
</div>
</div><div class="expand">
    <div class="expand-label" id="expand-label-3" style="cursor: pointer;">
        <span>
            
            
            Click here to see all code
            
        </span>
    </div>
    <div class="expand-content" id="expand-content-3" style="display: none;">
        <div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">264
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">265
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">266
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">267
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">268
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">269
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">270
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">271
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">272
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">273
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">274
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">275
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">276
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">277
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">278
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">279
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">280
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">281
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">282
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">283
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">284
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">285
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">286
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">287
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">288
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">289
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">290
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">291
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">292
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">293
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">294
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">295
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">296
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">297
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">298
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">299
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">300
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">301
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">302
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">303
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">304
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">305
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">306
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">307
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">308
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">309
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">310
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">311
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">312
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">313
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">314
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">315
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">316
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">317
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">318
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">319
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">320
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">321
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">322
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">323
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">324
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">325
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">326
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">327
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">328
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">329
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">330
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">331
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">332
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">333
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">334
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">335
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">336
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">337
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">338
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">339
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">340
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">341
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">342
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">343
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">344
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">345
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">346
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">347
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">348
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">349
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">350
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">351
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">352
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">353
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">354
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">355
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">356
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">357
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">358
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">359
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">360
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">361
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">362
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">363
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">364
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">365
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">366
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">367
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">368
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">var</span> saveImage = flag.<span style="color:#50fa7b">Bool</span>(<span style="color:#f1fa8c">&#34;saveImage&#34;</span>, <span style="color:#ff79c6">false</span>, <span style="color:#f1fa8c">&#34;save the result of running the benchmarks&#34;</span>)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b <span style="color:#ff79c6">*</span>testing.B, HorizontalImageChunks, VerticalImageChunks, ChunkImageSize, workers <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; b.N; i<span style="color:#ff79c6">++</span> {
		b.<span style="color:#50fa7b">StopTimer</span>()
		pic <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>mandelbrot.Picture{
			TopLeft:               <span style="color:#8be9fd;font-style:italic">complex</span>(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1.401854499759</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">0.000743603637</span>),
			MaxIterations:         <span style="color:#bd93f9">3534</span>,
			ChunkSize:             <span style="color:#bd93f9">0.00021646</span> <span style="color:#ff79c6">*</span> <span style="color:#8be9fd;font-style:italic">float64</span>(ChunkImageSize),
			HorizontalImageChunks: HorizontalImageChunks,
			VerticalImageChunks:   VerticalImageChunks,
			ChunkImageSize:        ChunkImageSize,
		}
		ctx <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">Background</span>()
		pic.<span style="color:#50fa7b">Init</span>()
		b.<span style="color:#50fa7b">StartTimer</span>()

		done <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">CalculateAsync</span>(ctx, workers)
		<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">range</span> done {

		}
		<span style="color:#ff79c6">if</span> <span style="color:#ff79c6">*</span>saveImage {
			b.<span style="color:#50fa7b">StopTimer</span>()
			<span style="color:#50fa7b">saveImageFrom</span>(pic, fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;bench_%d_%d_%d_w_%d.jpeg&#34;</span>, pic.HorizontalImageChunks, pic.VerticalImageChunks, pic.ChunkImageSize, workers))
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">saveImageFrom</span>(pic <span style="color:#ff79c6">*</span>mandelbrot.Picture, name <span style="color:#8be9fd">string</span>) {
	img <span style="color:#ff79c6">:=</span> image.<span style="color:#50fa7b">NewRGBA</span>(image.<span style="color:#50fa7b">Rect</span>(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, pic.<span style="color:#50fa7b">HorizontalResolution</span>(), pic.<span style="color:#50fa7b">VerticalResolution</span>()))
	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; pic.HorizontalImageChunks<span style="color:#ff79c6">*</span>pic.VerticalImageChunks; i<span style="color:#ff79c6">++</span> {
		offsetX, offsetY <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">GetImageOffsetFor</span>(i)
		<span style="color:#50fa7b">paintAreaInImage</span>(img, pic.<span style="color:#50fa7b">GetArea</span>(i), offsetX, offsetY)
	}
	outFile, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(name)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;output file cannot be opened, cause: %s&#34;</span>, err)
	}
	<span style="color:#ff79c6">defer</span> outFile.<span style="color:#50fa7b">Close</span>()

	encodingError <span style="color:#ff79c6">:=</span> jpeg.<span style="color:#50fa7b">Encode</span>(outFile, img, <span style="color:#ff79c6">&amp;</span>jpeg.Options{Quality: <span style="color:#bd93f9">90</span>})
	<span style="color:#ff79c6">if</span> encodingError <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#8be9fd;font-style:italic">panic</span>(err)
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">paintAreaInImage</span>(img <span style="color:#ff79c6">*</span>image.RGBA, area mandelbrot.Area, offsetX <span style="color:#8be9fd">int</span>, offsetY <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; x &lt; area.HorizontalResolution; x<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">for</span> y <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; y &lt; area.VerticalResolution; y<span style="color:#ff79c6">++</span> {
			point <span style="color:#ff79c6">:=</span> area.<span style="color:#50fa7b">GetPoint</span>(x, y)
			color <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">getColor</span>(point, []color.RGBA{
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
			}, area.MaxIterations, color.RGBA{
				A: <span style="color:#bd93f9">255</span>,
			})
			img.<span style="color:#50fa7b">SetRGBA</span>(offsetX<span style="color:#ff79c6">+</span>x, offsetY<span style="color:#ff79c6">+</span>y, color)
		}
	}
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getColor</span>(point mandelbrot.Point, palette []color.RGBA, maxIterations <span style="color:#8be9fd">int</span>, maxIterationsColor color.RGBA) color.RGBA {
	<span style="color:#ff79c6">if</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">==</span> maxIterations {
		<span style="color:#ff79c6">return</span> maxIterationsColor
	}
	index <span style="color:#ff79c6">:=</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">len</span>(palette)
	<span style="color:#ff79c6">return</span> palette[index]
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">1</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w1</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w2</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">2</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">3</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w3</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">3</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">4</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w4</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">4</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">5</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w5</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">5</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">6</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w6</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">6</span>)
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w7</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">7</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1024x1024x1w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks512x512x2w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks256x256x4w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks128x128x8w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks64x64x16w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks32x32x32w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">32</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks16x16x64w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">64</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks8x8x128w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">8</span>, <span style="color:#bd93f9">128</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks4x4x256w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">256</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks2x2x512w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">512</span>, <span style="color:#bd93f9">8</span>)
}
<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">BenchmarkComplexPictureChunks1x1x1024w8</span>(b <span style="color:#ff79c6">*</span>testing.B) {
	<span style="color:#50fa7b">benchmarkComplexPictureChunks</span>(b, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1024</span>, <span style="color:#bd93f9">8</span>)
}
</code></pre></td></tr></table>
</div>
</div>
    </div>
    <script>
        function collapse(e) {
            e = e || window.event;
            var target = e.target || e.srcElement,
                text = target.textContent || target.innerText;

            console.log("event received")
            console.log(target)

            target.classList.toggle("active");
            var content = this.nextElementSibling;
            console.log(content)
            console.log(content.style.display)
            if (content.style.display === "block") {
                content.style.display = "none";
                console.log(content.style.display)
            } else {
                content.style.display = "block";
            }
        }
        document.getElementById("expand-label-3").addEventListener("click", collapse);
    </script>
</div>
<p>It is important that the caller must read the channel <code>done</code> until the calculation ends because, if there is no receiver, the channel is blocked.</p>
<p>The <code>saveImage</code> is a flag passed to the test command to keep the generated image for each benchmark. This allows to visually verify that the benchmark is actually rendering the right image.</p>
<p>This is the section selected for the benchmarks. I&rsquo;m using a different method to give color to the set this time. I&rsquo;m using a color palette with 7 colors and I assign it based on the number of iterations. <code>color[iterations % len(color)]</code> This is awesome because always give the same color to a section independently of the zoom.</p>
<p><a target="_blank" rel="noopener noreferrer" 
  href="./bench.jpeg"><img  src="./bench.jpeg"
        alt="bench"/></a></p>
<h2 id="mandelbrot-cli">Mandelbrot CLI</h2>
<p>Let&rsquo;s create a CLI to generate awesome images of any given area.</p>
<p>To ease the final usage, I&rsquo;ve simplified the input parameters to some more human-friendly. The default values, generate a global view of the Mandelbrot in a 1920x1920 image.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">top <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;top&#34;</span>, <span style="color:#bd93f9">1.5</span>, <span style="color:#f1fa8c">&#34;Top mandelbrot position&#34;</span>)
left <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;left&#34;</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">2.1</span>, <span style="color:#f1fa8c">&#34;Left mandelbrot position&#34;</span>)
areaSize <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;areaSize&#34;</span>, <span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#34;From the TopLeft, the size of the complex area&#34;</span>)

imageSize <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;imageSize&#34;</span>, <span style="color:#bd93f9">1920</span>, <span style="color:#f1fa8c">&#34;Size of the squared image generated in pixels&#34;</span>)
divisions <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;divisions&#34;</span>, <span style="color:#bd93f9">50</span>, <span style="color:#f1fa8c">&#34;Number of divisions to split the work over multiple routines&#34;</span>)
maxIterations <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;maxIterations&#34;</span>, <span style="color:#bd93f9">100</span>, <span style="color:#f1fa8c">&#34;Maximum number of iterations per point&#34;</span>)

workers <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;workers&#34;</span>, runtime.<span style="color:#50fa7b">NumCPU</span>(), <span style="color:#f1fa8c">&#34;Maximum number of iterations per point&#34;</span>)
out <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;out&#34;</span>, <span style="color:#f1fa8c">&#34;mandelbrot.jpg&#34;</span>, <span style="color:#f1fa8c">&#34;output file, it can be png or jpg&#34;</span>)
timeout <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int64</span>(<span style="color:#f1fa8c">&#34;timeout&#34;</span>, <span style="color:#bd93f9">20</span>, <span style="color:#f1fa8c">&#34;Maximum number of seconds to compute, if reached. the program will exit&#34;</span>)

</code></pre></td></tr></table>
</div>
</div><p>With this flags, I directly call a <code>mandelbot.NewPicture</code> function that accepts this parameters and handles the conversion to the original parameters needed by the <code>mandelbot.Picture</code>. The only thing to adjust is the chunkSize based on the number of divisions to ensure that we draw the same area. The drawback is that we need to carefully select the number of divisions or it will be impossible to split the area in a whole number of divisions.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">pic <span style="color:#ff79c6">:=</span> mandelbrot.<span style="color:#50fa7b">NewPicture</span>(<span style="color:#8be9fd;font-style:italic">complex</span>(<span style="color:#ff79c6">*</span>left, <span style="color:#ff79c6">*</span>top), <span style="color:#ff79c6">*</span>areaSize, <span style="color:#ff79c6">*</span>imageSize, <span style="color:#ff79c6">*</span>divisions, <span style="color:#ff79c6">*</span>maxIterations)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">NewPicture</span>(topLeft <span style="color:#8be9fd">complex128</span>, chunkSize <span style="color:#8be9fd">float64</span>, imageSize <span style="color:#8be9fd">int</span>, divisions <span style="color:#8be9fd">int</span>, maxIterations <span style="color:#8be9fd">int</span>) <span style="color:#ff79c6">*</span>Picture {
	<span style="color:#ff79c6">if</span> imageSize<span style="color:#ff79c6">%</span>divisions <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span> {
		log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;WARNING: ImageSize %d can&#39;t be divided in %d divisions, The final image will be smaller&#34;</span>, imageSize, divisions)
	}
	chunkImageSize <span style="color:#ff79c6">:=</span> imageSize <span style="color:#ff79c6">/</span> divisions
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>Picture{
		TopLeft:               topLeft,
		MaxIterations:         maxIterations,
		ChunkSize:             chunkSize <span style="color:#ff79c6">/</span> <span style="color:#8be9fd;font-style:italic">float64</span>(divisions),
		HorizontalImageChunks: divisions,
		VerticalImageChunks:   divisions,
		ChunkImageSize:        chunkImageSize,
	}
}
</code></pre></td></tr></table>
</div>
</div><p>After calling <code>pic.Init()</code>, we can call <code>pic.CalculateAsync()</code> to get the <code>doneIndex</code> channel that will notify us about the progress. As we need a little bit of setup with a context and a picture. I will wrap the calculation in a function <code>Calculate</code> that accepts the <code>pic</code> and returns an <code>image.RGBA</code> ready to be exported.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Calculate</span>(timeout <span style="color:#8be9fd">int64</span>, workers <span style="color:#8be9fd">int</span>, pic <span style="color:#ff79c6">*</span>mandelbrot.Picture) (<span style="color:#ff79c6">*</span>image.RGBA, <span style="color:#8be9fd">error</span>) {
	ctx, ctxCancel <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">WithTimeout</span>(context.<span style="color:#50fa7b">Background</span>(), time.Second<span style="color:#ff79c6">*</span>time.<span style="color:#50fa7b">Duration</span>(timeout))
	<span style="color:#ff79c6">defer</span> <span style="color:#50fa7b">ctxCancel</span>()

	doneIndex <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">CalculateAsync</span>(ctx, workers)
	img <span style="color:#ff79c6">:=</span> image.<span style="color:#50fa7b">NewRGBA</span>(image.<span style="color:#50fa7b">Rect</span>(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, pic.<span style="color:#50fa7b">HorizontalResolution</span>(), pic.<span style="color:#50fa7b">VerticalResolution</span>()))

	<span style="color:#ff79c6">for</span> {
		<span style="color:#ff79c6">select</span> {
		<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
			<span style="color:#ff79c6">return</span> img, ctx.<span style="color:#50fa7b">Err</span>()
		<span style="color:#ff79c6">case</span> i, ok <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>doneIndex:
			<span style="color:#ff79c6">if</span> !ok {
				log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;Finished&#34;</span>)
				<span style="color:#ff79c6">return</span> img, <span style="color:#ff79c6">nil</span>
			}
			log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Index %d done&#34;</span>, i)
			offsetX, offsetY <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">GetImageOffsetFor</span>(i)
			<span style="color:#50fa7b">paintAreaInImage</span>(img, pic.<span style="color:#50fa7b">GetArea</span>(i), offsetX, offsetY)
		}
	}
}
</code></pre></td></tr></table>
</div>
</div><p>The <code>mandelbot.Picture</code> provides utility method that return information about the final image dimensions. This way, I can prepare the final image. In the for loop we wait for updates from the calculation and call a function to paint the finished Area into the final image. The method <code>picture.GetImageOffserFor</code> accepts an index and returns the <code>x,y</code> positions in the resolution of the final image. If the context is cancelled. the <code>Calculate</code> function returns a partial image and the error that canceled the context. This way, if the context is cancelled. The function returns almost immediately. This could be a serious bug because workers will never be able to finish their work. But it is not a problem here because the program will just save the image and exit. I will solve this in future posts.</p>
<p>Let&rsquo;s take a look into the <code>paintAreaInImage</code> function. It&rsquo;s purpose is to iterate over all the pixels in the area, assign them a color, and add it to the final Image. The function <code>getColor</code> accepts <code>(point mandelbrot.Point, palette []color.RGBA, maxIterations int, maxIterationsColor color.RGBA)</code>  The color is chosen by dividing the iterations over the len of the palette. This ensures that we the next color for every iterations and that we loop back to the first one when the length is reached. The maxIterations is needed to paint the &ldquo;Unknown&rdquo; area of a different color. In this case, Black color.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">paintAreaInImage</span>(img <span style="color:#ff79c6">*</span>image.RGBA, area mandelbrot.Area, offsetX <span style="color:#8be9fd">int</span>, offsetY <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; x &lt; area.HorizontalResolution; x<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">for</span> y <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; y &lt; area.VerticalResolution; y<span style="color:#ff79c6">++</span> {
			point <span style="color:#ff79c6">:=</span> area.<span style="color:#50fa7b">GetPoint</span>(x, y)
			color <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">getColor</span>(point, []color.RGBA{
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
			}, area.MaxIterations, color.RGBA{
				A: <span style="color:#bd93f9">255</span>,
			})
			img.<span style="color:#50fa7b">SetRGBA</span>(offsetX<span style="color:#ff79c6">+</span>x, offsetY<span style="color:#ff79c6">+</span>y, color)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getColor</span>(point mandelbrot.Point, palette []color.RGBA, maxIterations <span style="color:#8be9fd">int</span>, maxIterationsColor color.RGBA) color.RGBA {
	<span style="color:#ff79c6">if</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">==</span> maxIterations {
		<span style="color:#ff79c6">return</span> maxIterationsColor
	}
	index <span style="color:#ff79c6">:=</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">len</span>(palette)
	<span style="color:#ff79c6">return</span> palette[index]
}
</code></pre></td></tr></table>
</div>
</div><p>When the function <code>Calculate</code> returns, we have a img object that must be saved to a file. If you pay attention to the parameters accepted by the program, it says that accepts png and jpeg formats. To do so, we can use the function <code>filepath.Ext</code> to find the extension of the file name. As go already provides codecs for jpeg and png. The code is straight forward.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">outFile, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(<span style="color:#ff79c6">*</span>out)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
	log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;output file cannot be opened, cause: %s&#34;</span>, err)
}
<span style="color:#ff79c6">defer</span> outFile.<span style="color:#50fa7b">Close</span>()

<span style="color:#ff79c6">switch</span> filepath.<span style="color:#50fa7b">Ext</span>(<span style="color:#ff79c6">*</span>out) {
<span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;.jpg&#34;</span>, <span style="color:#f1fa8c">&#34;.jpeg&#34;</span>:
	encodingError <span style="color:#ff79c6">:=</span> jpeg.<span style="color:#50fa7b">Encode</span>(outFile, img, <span style="color:#ff79c6">&amp;</span>jpeg.Options{Quality: <span style="color:#bd93f9">90</span>})
	<span style="color:#ff79c6">if</span> encodingError <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#8be9fd;font-style:italic">panic</span>(err)
	}
<span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;.png&#34;</span>:
	encodingError <span style="color:#ff79c6">:=</span> png.<span style="color:#50fa7b">Encode</span>(outFile, img)
	<span style="color:#ff79c6">if</span> encodingError <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#8be9fd;font-style:italic">panic</span>(err)
	}
}
</code></pre></td></tr></table>
</div>
</div><div class="expand">
    <div class="expand-label" id="expand-label-4" style="cursor: pointer;">
        <span>
            
            
            Click here to see all code
            
        </span>
    </div>
    <div class="expand-content" id="expand-content-4" style="display: none;">
        <div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#ff79c6">package</span> main

<span style="color:#ff79c6">import</span> (
	<span style="color:#f1fa8c">&#34;context&#34;</span>
	<span style="color:#f1fa8c">&#34;flag&#34;</span>
	<span style="color:#f1fa8c">&#34;image&#34;</span>
	<span style="color:#f1fa8c">&#34;image/color&#34;</span>
	<span style="color:#f1fa8c">&#34;image/jpeg&#34;</span>
	<span style="color:#f1fa8c">&#34;image/png&#34;</span>
	<span style="color:#f1fa8c">&#34;log&#34;</span>
	<span style="color:#f1fa8c">&#34;os&#34;</span>
	<span style="color:#f1fa8c">&#34;path/filepath&#34;</span>
	<span style="color:#f1fa8c">&#34;runtime&#34;</span>
	<span style="color:#f1fa8c">&#34;time&#34;</span>

	<span style="color:#f1fa8c">&#34;github.com/metalblueberry/mandelbrot/mandelbrot&#34;</span>
)

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	top <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;top&#34;</span>, <span style="color:#bd93f9">1.5</span>, <span style="color:#f1fa8c">&#34;Top mandelbrot position&#34;</span>)
	left <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;left&#34;</span>, <span style="color:#ff79c6">-</span><span style="color:#bd93f9">2.1</span>, <span style="color:#f1fa8c">&#34;Left mandelbrot position&#34;</span>)
	areaSize <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Float64</span>(<span style="color:#f1fa8c">&#34;areaSize&#34;</span>, <span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#34;From the TopLeft, the size of the complex area&#34;</span>)

	imageSize <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;imageSize&#34;</span>, <span style="color:#bd93f9">1920</span>, <span style="color:#f1fa8c">&#34;Size of the squared image generated in pixels&#34;</span>)
	divisions <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;divisions&#34;</span>, <span style="color:#bd93f9">50</span>, <span style="color:#f1fa8c">&#34;Number of divisions to split the work over multiple routines&#34;</span>)
	maxIterations <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;maxIterations&#34;</span>, <span style="color:#bd93f9">100</span>, <span style="color:#f1fa8c">&#34;Maximum number of iterations per point&#34;</span>)

	workers <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int</span>(<span style="color:#f1fa8c">&#34;workers&#34;</span>, runtime.<span style="color:#50fa7b">NumCPU</span>(), <span style="color:#f1fa8c">&#34;Maximum number of iterations per point&#34;</span>)
	out <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">String</span>(<span style="color:#f1fa8c">&#34;out&#34;</span>, <span style="color:#f1fa8c">&#34;mandelbrot.jpg&#34;</span>, <span style="color:#f1fa8c">&#34;output file, it can be png or jpg&#34;</span>)
	timeout <span style="color:#ff79c6">:=</span> flag.<span style="color:#50fa7b">Int64</span>(<span style="color:#f1fa8c">&#34;timeout&#34;</span>, <span style="color:#bd93f9">20</span>, <span style="color:#f1fa8c">&#34;Maximum number of seconds to compute, if reached. the program will exit&#34;</span>)

	flag.<span style="color:#50fa7b">Parse</span>()

	log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Start&#34;</span>)

	pic <span style="color:#ff79c6">:=</span> mandelbrot.<span style="color:#50fa7b">NewPicture</span>(<span style="color:#8be9fd;font-style:italic">complex</span>(<span style="color:#ff79c6">*</span>left, <span style="color:#ff79c6">*</span>top), <span style="color:#ff79c6">*</span>areaSize, <span style="color:#ff79c6">*</span>imageSize, <span style="color:#ff79c6">*</span>divisions, <span style="color:#ff79c6">*</span>maxIterations)
	pic.<span style="color:#50fa7b">Init</span>()

	log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Calculation started&#34;</span>)

	img, err <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">Calculate</span>(<span style="color:#ff79c6">*</span>timeout, <span style="color:#ff79c6">*</span>workers, pic)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Calculation failed, image is not complete. cause: %s&#34;</span>, err)
	}

	outFile, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(<span style="color:#ff79c6">*</span>out)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		log.<span style="color:#50fa7b">Fatalf</span>(<span style="color:#f1fa8c">&#34;output file cannot be opened, cause: %s&#34;</span>, err)
	}
	<span style="color:#ff79c6">defer</span> outFile.<span style="color:#50fa7b">Close</span>()

	<span style="color:#ff79c6">switch</span> filepath.<span style="color:#50fa7b">Ext</span>(<span style="color:#ff79c6">*</span>out) {
	<span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;.jpg&#34;</span>, <span style="color:#f1fa8c">&#34;.jpeg&#34;</span>:
		encodingError <span style="color:#ff79c6">:=</span> jpeg.<span style="color:#50fa7b">Encode</span>(outFile, img, <span style="color:#ff79c6">&amp;</span>jpeg.Options{Quality: <span style="color:#bd93f9">90</span>})
		<span style="color:#ff79c6">if</span> encodingError <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			<span style="color:#8be9fd;font-style:italic">panic</span>(err)
		}
	<span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;.png&#34;</span>:
		encodingError <span style="color:#ff79c6">:=</span> png.<span style="color:#50fa7b">Encode</span>(outFile, img)
		<span style="color:#ff79c6">if</span> encodingError <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			<span style="color:#8be9fd;font-style:italic">panic</span>(err)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">Calculate</span>(timeout <span style="color:#8be9fd">int64</span>, workers <span style="color:#8be9fd">int</span>, pic <span style="color:#ff79c6">*</span>mandelbrot.Picture) (<span style="color:#ff79c6">*</span>image.RGBA, <span style="color:#8be9fd">error</span>) {
	ctx, ctxCancel <span style="color:#ff79c6">:=</span> context.<span style="color:#50fa7b">WithTimeout</span>(context.<span style="color:#50fa7b">Background</span>(), time.Second<span style="color:#ff79c6">*</span>time.<span style="color:#50fa7b">Duration</span>(timeout))
	<span style="color:#ff79c6">defer</span> <span style="color:#50fa7b">ctxCancel</span>()
	doneIndex <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">CalculateAsync</span>(ctx, workers)
	img <span style="color:#ff79c6">:=</span> image.<span style="color:#50fa7b">NewRGBA</span>(image.<span style="color:#50fa7b">Rect</span>(<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, pic.<span style="color:#50fa7b">HorizontalResolution</span>(), pic.<span style="color:#50fa7b">VerticalResolution</span>()))

	<span style="color:#ff79c6">for</span> {
		<span style="color:#ff79c6">select</span> {
		<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">&lt;-</span>ctx.<span style="color:#50fa7b">Done</span>():
			<span style="color:#ff79c6">return</span> img, ctx.<span style="color:#50fa7b">Err</span>()
		<span style="color:#ff79c6">case</span> i, ok <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&lt;-</span>doneIndex:
			<span style="color:#ff79c6">if</span> !ok {
				log.<span style="color:#50fa7b">Print</span>(<span style="color:#f1fa8c">&#34;Finished&#34;</span>)
				<span style="color:#ff79c6">return</span> img, <span style="color:#ff79c6">nil</span>
			}
			log.<span style="color:#50fa7b">Printf</span>(<span style="color:#f1fa8c">&#34;Index %d done&#34;</span>, i)
			offsetX, offsetY <span style="color:#ff79c6">:=</span> pic.<span style="color:#50fa7b">GetImageOffsetFor</span>(i)
			<span style="color:#50fa7b">paintAreaInImage</span>(img, pic.<span style="color:#50fa7b">GetArea</span>(i), offsetX, offsetY)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">paintAreaInImage</span>(img <span style="color:#ff79c6">*</span>image.RGBA, area mandelbrot.Area, offsetX <span style="color:#8be9fd">int</span>, offsetY <span style="color:#8be9fd">int</span>) {
	<span style="color:#ff79c6">for</span> x <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; x &lt; area.HorizontalResolution; x<span style="color:#ff79c6">++</span> {
		<span style="color:#ff79c6">for</span> y <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; y &lt; area.VerticalResolution; y<span style="color:#ff79c6">++</span> {
			point <span style="color:#ff79c6">:=</span> area.<span style="color:#50fa7b">GetPoint</span>(x, y)
			color <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">getColor</span>(point, []color.RGBA{
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
				color.RGBA{
					R: <span style="color:#bd93f9">255</span>,
					G: <span style="color:#bd93f9">255</span>,
					B: <span style="color:#bd93f9">255</span>,
					A: <span style="color:#bd93f9">255</span>,
				},
			}, area.MaxIterations, color.RGBA{
				A: <span style="color:#bd93f9">255</span>,
			})
			img.<span style="color:#50fa7b">SetRGBA</span>(offsetX<span style="color:#ff79c6">+</span>x, offsetY<span style="color:#ff79c6">+</span>y, color)
		}
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">getColor</span>(point mandelbrot.Point, palette []color.RGBA, maxIterations <span style="color:#8be9fd">int</span>, maxIterationsColor color.RGBA) color.RGBA {
	<span style="color:#ff79c6">if</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">==</span> maxIterations {
		<span style="color:#ff79c6">return</span> maxIterationsColor
	}
	index <span style="color:#ff79c6">:=</span> point.<span style="color:#50fa7b">Iterations</span>() <span style="color:#ff79c6">%</span> <span style="color:#8be9fd;font-style:italic">len</span>(palette)
	<span style="color:#ff79c6">return</span> palette[index]
}
</code></pre></td></tr></table>
</div>
</div>
    </div>
    <script>
        function collapse(e) {
            e = e || window.event;
            var target = e.target || e.srcElement,
                text = target.textContent || target.innerText;

            console.log("event received")
            console.log(target)

            target.classList.toggle("active");
            var content = this.nextElementSibling;
            console.log(content)
            console.log(content.style.display)
            if (content.style.display === "block") {
                content.style.display = "none";
                console.log(content.style.display)
            } else {
                content.style.display = "block";
            }
        }
        document.getElementById("expand-label-4").addEventListener("click", collapse);
    </script>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>This has been really interesting. I was not expecting a x6 speed but looks like I was wrong. I think that the optimal number of divisions comes from a tread-off between the capacity to split the work over multiple cores and the extra time required to send data over channels. I would like to benchmark the code again and see where is the bottle neck for each configuration.</p>
<p>I think that the next project will be to create a mandelbrot-server that provides a webpage when the user will be able to zoom in the set dynamically. It would be awesome!</p>
<p>Checkout the whole code in the repository. Here is the <a href="https://github.com/MetalBlueberry/go-mandelbrot/releases/tag/2019-11-17_mandelbrot_parallel_computation"target="_blank">link</a> to the tag that hold the code at this moment. You can also <a href="https://github.com/MetalBlueberry/go-mandelbrot/releases/download/2019-11-17_mandelbrot_parallel_computation/mandelbrot"target="_blank">download the binary</a> for linux! just in case you want to run it without installing go.</p>
<p>Thank you for reading and feel free to leave a comment bellow, I will be really happy to hear from you.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://golang.org/pkg/context/"target="_blank">Go context.Context</a></li>
<li><a href="https://golang.org/pkg/sync/#example_WaitGroup"target="_blank">Go sync.WaitGroup</a></li>
<li><a href="https://golang.org/pkg/image/"target="_blank">Go image</a></li>
<li><a href="https://tour.golang.org/concurrency/2"target="_blank">TourOfGo Channels</a></li>
<li><a href="https://medium.com/rungo/anatomy-of-channels-in-go-concurrency-in-go-1ec336086adb"target="_blank">Medium Anatomy of channels</a></li>
</ul></article><section class="article labels"><a class="category" href=/categories/howto/>howto</a><a class="tag" href=/tags/go/>go</a><a class="tag" href=/tags/mandelbrot/>mandelbrot</a></section></div><section class="article navigation"><p><a class="link" href="/post/blog/2019-11-24_avoid_github_government_block/"><span class="li">&larr;</span>Avoid Github Government Block</a></p><p><a class="link" href="/post/blog/2019-11-03_leadership_training/"><span class="li">&rarr;</span>Leadership Training</a></p></section><section class="article discussion"><script 
            src="https://utteranc.es/client.js" 
            repo="MetalBlueberry/MetalBlueberry.github.io"
            issue-term="og:title"
            label=""
            theme="github-light"
            crossorigin="anonymous" async>
        </script></section>
<div class="claps">
  <div class="canvas">
    <div id="totalCounter" class="total-counter"></div>

    <div id="clap" class="clap-container">
      <i class="clap-icon fa fa-hand-paper-o"></i>
    </div>

    <div id="clicker" class="click-counter">
      <span class="counter"></span>
    </div>

    <div id="sonar-clap" class="clap-container-sonar"></div>

    <div id="particles" class="particles-container">
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
    </div>

    <div id="particles-2" class="particles-container">
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
    </div>

    <div id="particles-3" class="particles-container">
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
      <div class="triangle">
        <div class="square"></div>
      </div>
    </div>

  </div>
</div><script>
  anchors.add();
</script></div><section id="footer" class="footer"><div class="footer-wrap">
    <p class="copyright">VÃ­ctor PÃ©rez Domingo</p>
    <p class="powerby"><span>Powered by </span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p>
</div></section>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-150427130-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script src="/js/core.min.6d58ae06d163dcf4ea5254fc7006ccd56745fa6fa5feb2b2e417538d70efb617823f575f338d25d3475ad418d50ae9b1.js" integrity="sha384-bViuBtFj3PTqUlT8cAbM1WdF&#43;m&#43;l/rKy5BdTjXDvtheCP1dfM40l00da1BjVCumx"></script></div>
</body>

</html>